<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.23">
<meta name="author" content="Tony Kay">
<title>State Charts for Clojure(script)</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.square{list-style-type:square}
ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child{border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:first-child,.sidebarblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child,.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active,#footnotes .footnote a:first-of-type:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,td.hdlist1,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<style>
/*! Stylesheet for CodeRay to loosely match GitHub themes | MIT License */
pre.CodeRay{background:#f7f7f8}
.CodeRay .line-numbers{border-right:1px solid;opacity:.35;padding:0 .5em 0 0;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
.CodeRay span.line-numbers{display:inline-block;margin-right:.75em}
.CodeRay .line-numbers strong{color:#000}
table.CodeRay{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.CodeRay td{vertical-align:top;line-height:inherit}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.code{padding:0 0 0 .75em}
.CodeRay .debug{color:#fff!important;background:navy!important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:navy}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:teal}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:teal}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:teal}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword{color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:teal}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>State Charts for Clojure(script)</h1>
<div class="details">
<span id="author" class="author">Tony Kay</span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_getting_started">1. Getting Started</a></li>
<li><a href="#_autonomous_state_charts">2. Autonomous State Charts</a></li>
<li><a href="#_async_execution_engine">3. Async Execution Engine</a>
<ul class="sectlevel2">
<li><a href="#_setting_up_the_async_engine">3.1. Setting Up the Async Engine</a></li>
<li><a href="#_using_async_expressions">3.2. Using Async Expressions</a></li>
</ul>
</li>
<li><a href="#_going_deeper">4. Going Deeper</a>
<ul class="sectlevel2">
<li><a href="#_terminology">4.1. Terminology</a></li>
<li><a href="#_states">4.2. States</a></li>
<li><a href="#_transitions">4.3. Transitions</a></li>
<li><a href="#_condition_states">4.4. "Condition" States</a></li>
<li><a href="#_flow_control_elements">4.5. Flow Control Elements</a>
<ul class="sectlevel3">
<li><a href="#_if_elseif_else">4.5.1. If / elseif / else</a></li>
<li><a href="#_foreach">4.5.2. foreach</a></li>
<li><a href="#_the_in_predicate">4.5.3. The <code>In</code> Predicate</a></li>
</ul>
</li>
<li><a href="#_event_processing">4.6. Event Processing</a>
<ul class="sectlevel3">
<li><a href="#_event_name_matching">4.6.1. Event Name Matching</a></li>
<li><a href="#_send_targets">4.6.2. Send Targets</a></li>
<li><a href="#_send_types">4.6.3. Send Types</a></li>
<li><a href="#_manual_polling_queue">4.6.4. Manual Polling Queue</a></li>
</ul>
</li>
<li><a href="#_data_models">4.7. Data Models</a></li>
<li><a href="#_execution_models">4.8. Execution Models</a></li>
<li><a href="#_working_memory_and_identity">4.9. Working Memory and Identity</a></li>
<li><a href="#_accessing_running_charts_from_outside_the_chart">4.10. Accessing Running Charts from Outside the Chart</a></li>
<li><a href="#_invocations">4.11. Invocations</a>
<ul class="sectlevel3">
<li><a href="#_passing_invocation_data">4.11.1. Passing Invocation Data</a></li>
<li><a href="#_invoking_other_state_charts_or_futures">4.11.2. Invoking other State Charts or Futures</a></li>
<li><a href="#_custom_invocation_processors">4.11.3. Custom Invocation Processors</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#Convenience">5. Shorthand Convenience</a></li>
<li><a href="#_custom_executable_content">6. Custom Executable Content</a></li>
<li><a href="#_integration_with_fulcro">7. Integration with Fulcro</a>
<ul class="sectlevel2">
<li><a href="#_basic_usage">7.1. Basic Usage</a></li>
<li><a href="#_the_data_model">7.2. The Data Model</a>
<ul class="sectlevel3">
<li><a href="#_initializing_the_data_model">7.2.1. Initializing the Data Model</a></li>
<li><a href="#_data_locations">7.2.2. Data Locations</a></li>
</ul>
</li>
<li><a href="#_executable_content">7.3. Executable Content</a>
<ul class="sectlevel3">
<li><a href="#_operations">7.3.1. Operations</a></li>
<li><a href="#_async_operations">7.3.2. Async Operations</a></li>
</ul>
</li>
<li><a href="#_useful_helpers">7.4. Useful Helpers</a>
<ul class="sectlevel3">
<li><a href="#_functions">7.4.1. Functions</a></li>
<li><a href="#_content_of_data_in_executable_content">7.4.2. Content of <code>data</code> in Executable Content</a></li>
<li><a href="#_runtime_env_of_executable_content">7.4.3. Runtime <code>env</code> of Executable Content</a></li>
</ul>
</li>
<li><a href="#_react_hooks">7.5. React Hooks</a></li>
<li><a href="#_hierarchical_routing">7.6. Hierarchical Routing</a>
<ul class="sectlevel3">
<li><a href="#_why_statechart_driven_routing">7.6.1. Why Statechart-Driven Routing?</a></li>
<li><a href="#_end_to_end_setup_walkthrough">7.6.2. End-to-End Setup Walkthrough</a></li>
<li><a href="#DefiningRoutes">7.6.3. Defining Routes</a></li>
<li><a href="#ComponentSetup">7.6.4. Component Setup Requirements</a></li>
<li><a href="#IstateDeepDive">7.6.5. Composed Routing with istate</a></li>
<li><a href="#_authentication_guard_pattern">7.6.6. Authentication Guard Pattern</a></li>
<li><a href="#_pluggable_url_codec">7.6.7. Pluggable URL Codec</a></li>
<li><a href="#BusyGuards">7.6.8. Busy Guards</a></li>
<li><a href="#HeadlessTesting">7.6.9. Headless Testing</a></li>
<li><a href="#_api_reference">7.6.10. API Reference</a></li>
<li><a href="#ComponentOptions">7.6.11. Component Options Reference</a></li>
<li><a href="#_route_configuration_validation">7.6.12. Route Configuration Validation</a></li>
<li><a href="#_routing_invariants">7.6.13. Routing Invariants</a></li>
<li><a href="#_common_gotchas_and_troubleshooting">7.6.14. Common Gotchas and Troubleshooting</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_testing">8. Testing</a>
<ul class="sectlevel2">
<li><a href="#_mocking">8.1. Mocking</a></li>
<li><a href="#_event_sendscancels">8.2. Event Sends/Cancels</a></li>
<li><a href="#_starting_in_a_specific_configuration">8.3. Starting in a Specific Configuration</a></li>
</ul>
</li>
<li><a href="#_relationship_to_scxml">9. Relationship to SCXML</a>
<ul class="sectlevel2">
<li><a href="#_related_work">9.1. Related Work</a></li>
<li><a href="#_conformance">9.2. Conformance</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_getting_started"><a class="anchor" href="#_getting_started"></a><a class="link" href="#_getting_started">1. Getting Started</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>A state chart is defined as a (nested) map.
Some of this content&#8217;s behavior is <a href="#Goals">configurable</a>.
The simplest setup is to use Clojure for the executable code and a simple flat data model that scopes all state charts to the session (running instance of state chart).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The SCXML standard is used for the semantics and processing, and MUCH of the overall structure.
We keep the idea that each node in the chart has a unique ID, but take some license with executable content.
Most of the "executable content" elements described in the SCXML standard have differences since we are not using XML.
Sometimes we assume you can get by with an expression on the parent element, or just a single child script node.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To make it easier to write the maps there are functions for each element type in the
<code>com.fulcrologic.statecharts.elements</code> namespace, and it is recommended that you use these because some of them validate their parameters and children.</p>
</div>
<div class="paragraph">
<p>Once you have a state chart definition you need to create a session, which is just a running instance of the chart.</p>
</div>
<div class="paragraph">
<p>Once you have a session, you can send events to it, and look at the content of the session (or store it, etc).</p>
</div>
<div class="paragraph">
<p>Here&#8217;s a traffic light example from the <code>src/examples</code> directory in this repository that leverages parallel and compound states to simulate traffic lights with pedestrian signals:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">traffic-light</span>
  (<span class="symbol">:require</span>
    [com.fulcrologic.statecharts <span class="symbol">:as</span> sc]
    [com.fulcrologic.statecharts.chart <span class="symbol">:refer</span> [statechart]]
    [com.fulcrologic.statecharts.elements <span class="symbol">:refer</span> [parallel state transition]]
    [com.fulcrologic.statecharts.events <span class="symbol">:refer</span> [new-event]]
    [com.fulcrologic.statecharts.protocols <span class="symbol">:as</span> sp]
    [com.fulcrologic.statecharts.simple <span class="symbol">:as</span> simple]
    [com.fulcrologic.statecharts.util <span class="symbol">:refer</span> [extend-key]]))

(<span class="keyword">def</span> <span class="function">nk</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">(nk :a </span><span class="content">\&quot;</span><span class="content">b</span><span class="content">\&quot;</span><span class="content">) =&gt; :a/b
   (nk :a/b </span><span class="content">\&quot;</span><span class="content">c</span><span class="content">\&quot;</span><span class="content">) =&gt; :a.b/c</span><span class="delimiter">&quot;</span></span>
  extend-key)

(<span class="keyword">defn</span> <span class="function">traffic-signal</span> [id initial]
  (<span class="keyword">let</span> [red     (nk id <span class="string"><span class="delimiter">&quot;</span><span class="content">red</span><span class="delimiter">&quot;</span></span>)
        yellow  (nk id <span class="string"><span class="delimiter">&quot;</span><span class="content">yellow</span><span class="delimiter">&quot;</span></span>)
        green   (nk id <span class="string"><span class="delimiter">&quot;</span><span class="content">green</span><span class="delimiter">&quot;</span></span>)
        initial (nk id (<span class="keyword">name</span> initial))]
    (state {<span class="symbol">:id</span>      id
            <span class="symbol">:initial</span> initial}
      (state {<span class="symbol">:id</span> red}
        (transition {<span class="symbol">:event</span> <span class="symbol">:swap-flow</span> <span class="symbol">:target</span> green}))
      (state {<span class="symbol">:id</span> yellow}
        (transition {<span class="symbol">:event</span> <span class="symbol">:swap-flow</span> <span class="symbol">:target</span> red}))
      (state {<span class="symbol">:id</span> green}
        (transition {<span class="symbol">:event</span>  <span class="symbol">:warn-traffic</span>
                     <span class="symbol">:target</span> yellow})))))

(<span class="keyword">defn</span> <span class="function">ped-signal</span> [id initial]
  (<span class="keyword">let</span> [red            (nk id <span class="string"><span class="delimiter">&quot;</span><span class="content">red</span><span class="delimiter">&quot;</span></span>)
        flashing-white (nk id <span class="string"><span class="delimiter">&quot;</span><span class="content">flashing-white</span><span class="delimiter">&quot;</span></span>)
        white          (nk id <span class="string"><span class="delimiter">&quot;</span><span class="content">white</span><span class="delimiter">&quot;</span></span>)
        initial        (nk id (<span class="keyword">name</span> initial))]
    (state {<span class="symbol">:id</span>      id
            <span class="symbol">:initial</span> initial}
      (state {<span class="symbol">:id</span> red}
        (transition {<span class="symbol">:event</span> <span class="symbol">:swap-flow</span> <span class="symbol">:target</span> white}))
      (state {<span class="symbol">:id</span> flashing-white}
        (transition {<span class="symbol">:event</span> <span class="symbol">:swap-flow</span> <span class="symbol">:target</span> red}))
      (state {<span class="symbol">:id</span> white}
        (transition {<span class="symbol">:event</span> <span class="symbol">:warn-pedestrians</span> <span class="symbol">:target</span> flashing-white})))))

(<span class="keyword">def</span> <span class="function">traffic-lights</span>
  (statechart {}
    (parallel {}
      (traffic-signal <span class="symbol">:east-west</span> <span class="symbol">:green</span>)
      (traffic-signal <span class="symbol">:north-south</span> <span class="symbol">:red</span>)

      (ped-signal <span class="symbol">:cross-ew</span> <span class="symbol">:red</span>)
      (ped-signal <span class="symbol">:cross-ns</span> <span class="symbol">:white</span>))))

(<span class="keyword">defn</span> <span class="function">show-states</span> [wmem]
  (<span class="keyword">println</span>
    (<span class="keyword">sort</span>
      (<span class="keyword">filter</span> #{<span class="symbol">:north-south/red</span>
                <span class="symbol">:north-south/yellow</span>
                <span class="symbol">:north-south/green</span>
                <span class="symbol">:east-west/red</span>
                <span class="symbol">:east-west/yellow</span>
                <span class="symbol">:east-west/green</span>
                <span class="symbol">:cross-ns/red</span>
                <span class="symbol">:cross-ns/white</span>
                <span class="symbol">:cross-ns/flashing-white</span>
                <span class="symbol">:cross-ew/red</span>
                <span class="symbol">:cross-ew/white</span>
                <span class="symbol">:cross-ew/flashing-white</span>}
        (<span class="symbol">::sc/configuration</span> wmem)))))

(<span class="keyword">def</span> <span class="function">env</span> (simple/simple-env))
(simple/register! env <span class="symbol">::lights</span> traffic-lights)
(<span class="keyword">def</span> <span class="function">processor</span> (<span class="symbol">::sc/processor</span> env))
(<span class="keyword">def</span> <span class="function">s0</span> (sp/start! processor env <span class="symbol">::lights</span> {<span class="symbol">::sc/session-id</span> <span class="integer">1</span>}))
(show-states s0)
(<span class="keyword">def</span> <span class="function">s1</span> (sp/process-event! processor env s0 (new-event <span class="symbol">:warn-pedestrians</span>)))
(show-states s1)
(<span class="keyword">def</span> <span class="function">s2</span> (sp/process-event! processor env s1 (new-event <span class="symbol">:warn-traffic</span>)))
(show-states s2)
(<span class="keyword">def</span> <span class="function">s3</span> (sp/process-event! processor env s2 (new-event <span class="symbol">:swap-flow</span>)))
(show-states s3)
(<span class="keyword">def</span> <span class="function">s4</span> (sp/process-event! processor env s3 (new-event <span class="symbol">:warn-pedestrians</span>)))
(show-states s4)
(<span class="keyword">def</span> <span class="function">s5</span> (sp/process-event! processor env s4 (new-event <span class="symbol">:warn-traffic</span>)))
(show-states s5)
(<span class="keyword">def</span> <span class="function">s6</span> (sp/process-event! processor env s5 (new-event <span class="symbol">:swap-flow</span>)))
(show-states s6)</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you run the items in the comment block, you&#8217;ll see:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="symbol">:cross-ew/red</span> <span class="symbol">:cross-ns/white</span> <span class="symbol">:east-west/green</span> <span class="symbol">:north-south/red</span>)
(<span class="symbol">:cross-ew/red</span> <span class="symbol">:cross-ns/flashing-white</span> <span class="symbol">:east-west/green</span> <span class="symbol">:north-south/red</span>)
(<span class="symbol">:cross-ew/red</span> <span class="symbol">:cross-ns/flashing-white</span> <span class="symbol">:east-west/yellow</span> <span class="symbol">:north-south/red</span>)
(<span class="symbol">:cross-ew/white</span> <span class="symbol">:cross-ns/red</span> <span class="symbol">:east-west/red</span> <span class="symbol">:north-south/green</span>)
(<span class="symbol">:cross-ew/flashing-white</span> <span class="symbol">:cross-ns/red</span> <span class="symbol">:east-west/red</span> <span class="symbol">:north-south/green</span>)
(<span class="symbol">:cross-ew/flashing-white</span> <span class="symbol">:cross-ns/red</span> <span class="symbol">:east-west/red</span> <span class="symbol">:north-south/yellow</span>)
(<span class="symbol">:cross-ew/red</span> <span class="symbol">:cross-ns/white</span> <span class="symbol">:east-west/green</span> <span class="symbol">:north-south/red</span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>History support includes both shallow and deep.
Here&#8217;s a shallow example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">history-sample</span>
  (<span class="symbol">:require</span>
    [com.fulcrologic.statecharts <span class="symbol">:as</span> sc]
    [com.fulcrologic.statecharts.chart <span class="symbol">:refer</span> [statechart]]
    [com.fulcrologic.statecharts.elements <span class="symbol">:refer</span> [history state transition]]
    [com.fulcrologic.statecharts.events <span class="symbol">:refer</span> [new-event]]
    [com.fulcrologic.statecharts.protocols <span class="symbol">:as</span> sp]
    [com.fulcrologic.statecharts.simple <span class="symbol">:as</span> simple]))

(<span class="keyword">def</span> <span class="function">sample</span>
  (statechart {}
    (state {<span class="symbol">:id</span> <span class="symbol">:TOP</span>}
      (state {<span class="symbol">:id</span> <span class="symbol">:A</span>}
        (transition {<span class="symbol">:event</span> <span class="symbol">:top</span> <span class="symbol">:target</span> <span class="symbol">:B</span>}))
      (state {<span class="symbol">:id</span> <span class="symbol">:B</span>}
        <span class="comment">;; Could transition to :C, but that won't restore history.</span>
        <span class="comment">;; Transitioning to (one of) the history nodes in C</span>
        <span class="comment">;; directly restores history (you can have more than</span>
        <span class="comment">;; one because you might want different &quot;default&quot; targets</span>
        <span class="comment">;; for when there is no history).</span>
        (transition {<span class="symbol">:event</span> <span class="symbol">:top</span> <span class="symbol">:target</span> <span class="symbol">:Ch</span>}))
      (state {<span class="symbol">:id</span> <span class="symbol">:C</span>}
        (transition {<span class="symbol">:event</span> <span class="symbol">:top</span> <span class="symbol">:target</span> <span class="symbol">:A</span>})
        (history {<span class="symbol">:id</span> <span class="symbol">:Ch</span>}
          (transition {<span class="symbol">:target</span> <span class="symbol">:C1</span>}))
        (state {<span class="symbol">:id</span> <span class="symbol">:C1</span>}
          (transition {<span class="symbol">:event</span> <span class="symbol">:sub</span> <span class="symbol">:target</span> <span class="symbol">:C2</span>}))
        (state {<span class="symbol">:id</span> <span class="symbol">:C2</span>}
          (transition {<span class="symbol">:event</span> <span class="symbol">:sub</span> <span class="symbol">:target</span> <span class="symbol">:C1</span>}))))))

(<span class="keyword">defn</span> <span class="function">show-states</span> [wmem] (<span class="keyword">println</span> (<span class="keyword">sort</span> (<span class="symbol">::sc/configuration</span> wmem))))
(<span class="keyword">def</span> <span class="function">env</span> (simple/simple-env))
(simple/register! env `sample sample)
(<span class="keyword">def</span> <span class="function">processor</span> (<span class="symbol">::sc/processor</span> env))

(<span class="keyword">def</span> <span class="function">s0</span> (sp/start! processor env `sample {<span class="symbol">::sc/session-id</span> <span class="integer">1</span>}))
(show-states s0)
<span class="comment">;; :TOP :A</span>

(<span class="keyword">def</span> <span class="function">s1</span> (sp/process-event! processor env s0 (new-event <span class="symbol">:top</span>)))
(show-states s1)
<span class="comment">;; :TOP :B</span>

(<span class="keyword">def</span> <span class="function">s2</span> (sp/process-event! processor env s1 (new-event <span class="symbol">:top</span>)))
(show-states s2)
<span class="comment">;; :TOP :C :C1</span>

(<span class="keyword">def</span> <span class="function">s3</span> (sp/process-event! processor env s2 (new-event <span class="symbol">:sub</span>)))
(show-states s3)
<span class="comment">;; :TOP :C :C2</span>

(<span class="keyword">def</span> <span class="function">s4</span> (sp/process-event! processor env s3 (new-event <span class="symbol">:top</span>)))
(show-states s4)
<span class="comment">;; :TOP :A</span>

(<span class="keyword">def</span> <span class="function">s5</span> (sp/process-event! processor env s4 (new-event <span class="symbol">:top</span>)))
(show-states s5)
<span class="comment">;; :TOP :B</span>

(<span class="keyword">def</span> <span class="function">s6</span> (sp/process-event! processor env s5 (new-event <span class="symbol">:top</span>)))
(show-states s6)
<span class="comment">;; :TOP :C :C2 (history remembered)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>See the <a href="https://www.w3.org/TR/2015/REC-scxml-20150901/">SCXML spec</a> for how to structure elements.
The structure and naming are kept close to that spec for easy cross-referencing with its documentation.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_autonomous_state_charts"><a class="anchor" href="#_autonomous_state_charts"></a><a class="link" href="#_autonomous_state_charts">2. Autonomous State Charts</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The pure functional form for the charts is interesting and useful as a building-block, but if you want a fully-function SCXML-compatible system, you needs something that can run, deliver delayed events, send events from one state chart session to another, start/stop nested state charts, etc.</p>
</div>
<div class="paragraph">
<p>In order for this to work you must have a number of things: an event queue, invocation processor(s), a data/execution model, a working memory storage facility, a state chart registry, and an event loop.</p>
</div>
<div class="paragraph">
<p>That&#8217;s a lot of different things to set up!</p>
</div>
<div class="paragraph">
<p>The <code>com.fulcrologic.statecharts.simple</code> namespace can set up all of these things for you, as long as you simply want to run state charts all in the same JVM in RAM.
That namespace also includes helper functions for starting a new session on a chart, and sending events to arbitrary sessions.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The design of this library is meant to accomplish much more complex distributed and long-lived systems, but you have to implement the various protocols for each of the above elements to build such a thing.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The basic steps for using <code>simple</code> are:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a <code>(simple/simple-env)</code></p>
</li>
<li>
<p>Register your charts with the state chart registry in that env with <code>(simple/register! env k chart)</code></p>
</li>
<li>
<p>Run an event loop.
The <code>com.fulcrologic.statecharts.event-queue.core-async-event-loop/run-event-loop!</code>
uses <code>core.async</code> to run such a loop for you.</p>
</li>
<li>
<p>Start one or more state charts, via the <code>k</code> you registered them under.</p>
</li>
<li>
<p>(optionally) Send events <code>(simple/send! env {:event :evt :target sessionid})</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Below is an example that uses these steps, but also overrides one of the components in the env (the working memory store) so it can output messages as the state chart changes state:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">traffic-light-async</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">A demo that uses the core.async queue to demonstrate a running machine that can just be
   sent events and mutates in place (and handles timers in CLJC) via core.async.</span><span class="delimiter">&quot;</span></span>
  (<span class="symbol">:require</span>
    [com.fulcrologic.statecharts <span class="symbol">:as</span> sc]
    [com.fulcrologic.statecharts.chart <span class="symbol">:refer</span> [statechart]]
    [com.fulcrologic.statecharts.elements <span class="symbol">:refer</span> [Send on-entry parallel state transition]]
    [com.fulcrologic.statecharts.event-queue.core-async-event-loop <span class="symbol">:as</span> <span class="keyword">loop</span>]
    [com.fulcrologic.statecharts.events <span class="symbol">:as</span> evts]
    [com.fulcrologic.statecharts.protocols <span class="symbol">:as</span> sp]
    [com.fulcrologic.statecharts.simple <span class="symbol">:as</span> simple]
    [com.fulcrologic.statecharts.util <span class="symbol">:refer</span> [extend-key]]))

(<span class="keyword">def</span> <span class="function">nk</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">(nk :a </span><span class="content">\&quot;</span><span class="content">b</span><span class="content">\&quot;</span><span class="content">) =&gt; :a/b
   (nk :a/b </span><span class="content">\&quot;</span><span class="content">c</span><span class="content">\&quot;</span><span class="content">) =&gt; :a.b/c</span><span class="delimiter">&quot;</span></span>
  extend-key)

(<span class="keyword">def</span> <span class="function">flow-time</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">How long to wait before flashing ped warning</span><span class="delimiter">&quot;</span></span> <span class="integer">2000</span>)
(<span class="keyword">def</span> <span class="function">flashing-white-time</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">How long do we warn peds?</span><span class="delimiter">&quot;</span></span> <span class="integer">500</span>)
(<span class="keyword">def</span> <span class="function">yellow-time</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">How long do we warn cars</span><span class="delimiter">&quot;</span></span> <span class="integer">200</span>)

(<span class="keyword">defn</span> <span class="function">timer</span> []
  (state {<span class="symbol">:id</span> <span class="symbol">:timer-control</span>}
    (state {<span class="symbol">:id</span> <span class="symbol">:timing-flow</span>}
      (transition {<span class="symbol">:event</span>  <span class="symbol">:warn-pedestrians</span>
                   <span class="symbol">:target</span> <span class="symbol">:timing-ped-warning</span>})
      (on-entry {}
        (Send {<span class="symbol">:event</span> <span class="symbol">:warn-pedestrians</span>
               <span class="symbol">:delay</span> flow-time})))
    (state {<span class="symbol">:id</span> <span class="symbol">:timing-ped-warning</span>}
      (transition {<span class="symbol">:event</span>  <span class="symbol">:warn-traffic</span>
                   <span class="symbol">:target</span> <span class="symbol">:timing-yellow</span>})
      (on-entry {}
        (Send {<span class="symbol">:event</span> <span class="symbol">:warn-traffic</span>
               <span class="symbol">:delay</span> flashing-white-time})))
    (state {<span class="symbol">:id</span> <span class="symbol">:timing-yellow</span>}
      (transition {<span class="symbol">:event</span>  <span class="symbol">:swap-flow</span>
                   <span class="symbol">:target</span> <span class="symbol">:timing-flow</span>})
      (on-entry {}
        (Send {<span class="symbol">:event</span> <span class="symbol">:swap-flow</span>
               <span class="symbol">:delay</span> yellow-time})))))

(<span class="keyword">defn</span> <span class="function">traffic-signal</span> [id initial]
  (<span class="keyword">let</span> [red     (nk id <span class="string"><span class="delimiter">&quot;</span><span class="content">red</span><span class="delimiter">&quot;</span></span>)
        yellow  (nk id <span class="string"><span class="delimiter">&quot;</span><span class="content">yellow</span><span class="delimiter">&quot;</span></span>)
        green   (nk id <span class="string"><span class="delimiter">&quot;</span><span class="content">green</span><span class="delimiter">&quot;</span></span>)
        initial (nk id (<span class="keyword">name</span> initial))]
    (state {<span class="symbol">:id</span>      id
            <span class="symbol">:initial</span> initial}
      (state {<span class="symbol">:id</span> red}
        (transition {<span class="symbol">:event</span> <span class="symbol">:swap-flow</span> <span class="symbol">:target</span> green}))
      (state {<span class="symbol">:id</span> yellow}
        (transition {<span class="symbol">:event</span> <span class="symbol">:swap-flow</span> <span class="symbol">:target</span> red}))
      (state {<span class="symbol">:id</span> green}
        (transition {<span class="symbol">:event</span>  <span class="symbol">:warn-traffic</span>
                     <span class="symbol">:target</span> yellow})))))

(<span class="keyword">defn</span> <span class="function">ped-signal</span> [id initial]
  (<span class="keyword">let</span> [red            (nk id <span class="string"><span class="delimiter">&quot;</span><span class="content">red</span><span class="delimiter">&quot;</span></span>)
        flashing-white (nk id <span class="string"><span class="delimiter">&quot;</span><span class="content">flashing-white</span><span class="delimiter">&quot;</span></span>)
        white          (nk id <span class="string"><span class="delimiter">&quot;</span><span class="content">white</span><span class="delimiter">&quot;</span></span>)
        initial        (nk id (<span class="keyword">name</span> initial))]
    (state {<span class="symbol">:id</span>      id
            <span class="symbol">:initial</span> initial}
      (state {<span class="symbol">:id</span> red}
        (transition {<span class="symbol">:event</span> <span class="symbol">:swap-flow</span> <span class="symbol">:target</span> white}))
      (state {<span class="symbol">:id</span> flashing-white}
        (transition {<span class="symbol">:event</span> <span class="symbol">:swap-flow</span> <span class="symbol">:target</span> red}))
      (state {<span class="symbol">:id</span> white}
        (transition {<span class="symbol">:event</span> <span class="symbol">:warn-pedestrians</span> <span class="symbol">:target</span> flashing-white})))))

(<span class="keyword">def</span> <span class="function">traffic-lights</span>
  (statechart {}
    (parallel {}
      (timer)

      (traffic-signal <span class="symbol">:east-west</span> <span class="symbol">:green</span>)
      (traffic-signal <span class="symbol">:north-south</span> <span class="symbol">:red</span>)

      (ped-signal <span class="symbol">:cross-ew</span> <span class="symbol">:red</span>)
      (ped-signal <span class="symbol">:cross-ns</span> <span class="symbol">:white</span>))))

(<span class="keyword">defn</span> <span class="function">show-states</span> [wmem]
  (<span class="keyword">println</span> (<span class="keyword">sort</span> (<span class="keyword">filter</span> #{<span class="symbol">:north-south/red</span>
                           <span class="symbol">:north-south/yellow</span>
                           <span class="symbol">:north-south/green</span>
                           <span class="symbol">:east-west/red</span>
                           <span class="symbol">:east-west/yellow</span>
                           <span class="symbol">:east-west/green</span>
                           <span class="symbol">:cross-ns/red</span>
                           <span class="symbol">:cross-ns/white</span>
                           <span class="symbol">:cross-ns/flashing-white</span>
                           <span class="symbol">:cross-ew/red</span>
                           <span class="symbol">:cross-ew/white</span>
                           <span class="symbol">:cross-ew/flashing-white</span>} (<span class="symbol">::sc/configuration</span> wmem)))))


(<span class="keyword">comment</span>
  <span class="comment">;; Setup steps</span>
  (<span class="keyword">do</span>
    (<span class="keyword">def</span> <span class="function">session-id</span> <span class="integer">1</span>)
    <span class="comment">;; Override the working memory store so we can watch our working memory change</span>
    (<span class="keyword">def</span> <span class="function">wmem</span> (<span class="keyword">let</span> [a (<span class="keyword">atom</span> {})] (<span class="keyword">add-watch</span> a <span class="symbol">:printer</span> (<span class="keyword">fn</span> [_ _ _ n] (show-states n))) a))
    <span class="comment">;; Create an env that has all the components needed, but override the working memory store</span>
    (<span class="keyword">def</span> <span class="function">env</span> (simple/simple-env
               {<span class="symbol">::sc/working-memory-store</span>
                (<span class="keyword">reify</span> sp/WorkingMemoryStore
                  (get-working-memory [_ _ _] @wmem)
                  (save-working-memory! [_ _ _ m] (<span class="keyword">reset!</span> wmem m)))}))

    <span class="comment">;; Register the chart under a well-known name</span>
    (simple/register! env <span class="symbol">::lights</span> traffic-lights)

    <span class="comment">;; Run an event loop that polls the queue every 100ms</span>
    (<span class="keyword">def</span> <span class="function">running?</span> (loop/run-event-loop! env <span class="integer">100</span>)))

  <span class="comment">;; Start takes the well-known ID of a chart that should be started. The working memory is tracked internally.</span>
  <span class="comment">;; You should see the tracking installed above emit the traffic signal pattern</span>
  (simple/start! env <span class="symbol">::lights</span> session-id)

  <span class="comment">;; Tell the state machine to exit abruptly</span>
  (simple/send! env {<span class="symbol">:target</span> session-id
                     <span class="symbol">:event</span>  evts/cancel-event})

  <span class="comment">;; Stop event loop</span>
  (<span class="keyword">reset!</span> running? <span class="predefined-constant">false</span>))</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The <code>send</code> element has a <code>Send</code> (capital S) alias so you can avoid shadowing the predefined Clojure function.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_async_execution_engine"><a class="anchor" href="#_async_execution_engine"></a><a class="link" href="#_async_execution_engine">3. Async Execution Engine</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The library includes an async-capable execution engine built on <a href="https://github.com/funcool/promesa">promesa</a> that allows expressions to return promises the algorithm awaits.
When all expressions are synchronous, the overhead is minimal.
When an expression returns a promise, the algorithm parks until it resolves before continuing.</p>
</div>
<div class="paragraph">
<p>Both <code>start!</code> and <code>process-event!</code> may return promises instead of plain values.
Callers must handle both cases.
The easiest approach is to use <code>promesa.core/let</code> or <code>promesa.core/then</code> which handle both synchronous values and promises transparently.</p>
</div>
<div class="paragraph">
<p>The motivation for this features is CLJS statecharts, because the js ecosystem has a ton of promise-based asynchrony.
In CLJ, you can write script tags that <strong>block</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(state {<span class="symbol">:id</span> <span class="symbol">:state/foo</span>}
  (on-entry {}
    (script-fn [env data] (db/run-query! <span class="string"><span class="delimiter">&quot;</span><span class="content">A</span><span class="delimiter">&quot;</span></span>)) <span class="comment">; blocks</span>
    (script-fn [env data]  <span class="comment">; runs AFTER the first script</span>
      (<span class="keyword">if</span> (condition-needing-loaded-data-from-a)
        (db/run-query! <span class="string"><span class="delimiter">&quot;</span><span class="content">B</span><span class="delimiter">&quot;</span></span>))))
  (state {<span class="symbol">:id</span> <span class="symbol">:nested-state</span>} <span class="comment">; IS NOT entered until all scripts finish</span>
    <span class="keyword">..</span><span class="keyword">.</span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>but in JS-land, I/O is async, meaning you end up writing a bunch of states to "track progress".
IF you use the async engine, then returning a promise from a script will cause the statechart to PARK until the promise completes, allowing you to write much simpler charts.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
This is an <strong>opt-in</strong> feature.
The Fulcro integration can use it simply by passing a single parameter when you install the statecharts support.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_setting_up_the_async_engine"><a class="anchor" href="#_setting_up_the_async_engine"></a><a class="link" href="#_setting_up_the_async_engine">3.1. Setting Up the Async Engine</a></h3>
<div class="paragraph">
<p>Use the <code>com.fulcrologic.statecharts.simple-async</code> namespace for automatic configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">require</span> '[com.fulcrologic.statecharts.simple-async <span class="symbol">:as</span> simple-async])

(<span class="keyword">let</span> [env (simple-async/simple-env)]
  (simple-async/register! env <span class="symbol">:my-chart</span> my-chart)
  (simple-async/start! env <span class="symbol">:my-chart</span> session-id))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or compose manually:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">require</span> '[com.fulcrologic.statecharts.algorithms.v20150901-async <span class="symbol">:as</span> alg]
         '[com.fulcrologic.statecharts.execution-model.lambda-async <span class="symbol">:as</span> lambda-async])

{<span class="symbol">::sc/processor</span> (alg/new-processor)
 <span class="symbol">::sc/execution-model</span> (lambda-async/new-execution-model dm event-queue)}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The async engine requires promesa on the classpath.
Add it to your <code>deps.edn</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:deps</span> {funcool/promesa {<span class="symbol">:mvn/version</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">11.0.678</span><span class="delimiter">&quot;</span></span>}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or use the <code>:async</code> alias if available in the project.</p>
</div>
</div>
<div class="sect2">
<h3 id="_using_async_expressions"><a class="anchor" href="#_using_async_expressions"></a><a class="link" href="#_using_async_expressions">3.2. Using Async Expressions</a></h3>
<div class="paragraph">
<p>Any expression (predicates, script nodes, etc.) can return a promise:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(state {<span class="symbol">:id</span> <span class="symbol">:loading</span>}
  (on-entry {}
    (script {<span class="symbol">:expr</span> (<span class="keyword">fn</span> [env data]
                     (p/let [result (http/get <span class="string"><span class="delimiter">&quot;</span><span class="content">/api/data</span><span class="delimiter">&quot;</span></span>)]
                       [(ops/assign <span class="symbol">:result</span> result)]))})))</code></pre>
</div>
</div>
<div class="paragraph">
<p>The algorithm will automatically detect promises and await them.
Synchronous expressions continue to work without change.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_going_deeper"><a class="anchor" href="#_going_deeper"></a><a class="link" href="#_going_deeper">4. Going Deeper</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can use the <a href="http://www.w3.org/TR/2015/REC-scxml-20150901/">SCXML guide</a> which has examples as a pretty good reference for documentation.
The document structure in XML is nearly identical to the data structure of this library:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;scxml&gt;</span>
  <span class="tag">&lt;state</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">A</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  ...
  <span class="tag">&lt;/scxml&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(statechart {}
  (state {<span class="symbol">:id</span> <span class="symbol">:A</span>})
  <span class="keyword">..</span><span class="keyword">.</span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>See the docstrings on the <code>statechart</code> and various elements for details of differences.</p>
</div>
<div class="sect2">
<h3 id="_terminology"><a class="anchor" href="#_terminology"></a><a class="link" href="#_terminology">4.1. Terminology</a></h3>
<div class="dlist">
<dl>
<dt class="hdlist1">Atomic State</dt>
<dd>
<p>A state that does not have child states.</p>
</dd>
<dt class="hdlist1">Compound State</dt>
<dd>
<p>A state that has child <strong>states</strong>, where at most <strong>one</strong> child is active at any given time.</p>
</dd>
<dt class="hdlist1">Parallel State</dt>
<dd>
<p>A state that has more than one compound child state, all of which are active at the same time, and thus have a child state that is active.</p>
</dd>
<dt class="hdlist1">Configuration</dt>
<dd>
<p>When used in the context of a state chart, the configuration is the list of all active states.
A state is active if it or ANY of its children are active.
Thus, a parallel state chart with hierarchical states may have a rather large set of IDs in its current configuration.</p>
</dd>
<dt class="hdlist1">Working Memory</dt>
<dd>
<p>A map of data that contains the current configuration of the state chart, and other information necessary to know its current full state (which states have had their data model initialized, possible data model tracking, etc.).</p>
</dd>
<dt class="hdlist1">DataModel</dt>
<dd>
<p>An implementation of the data model protocol defines how the data model of your chart works.
The simple implementation places the data in Working Memory, and treats lookups as paths into a single top-level map scoped to the session (running chart instance).</p>
</dd>
<dt class="hdlist1">ExecutionModel</dt>
<dd>
<p>An implementation of this protocol is handed the expressions that are included on the state chart, and chooses how to run them.
A default implementation requires that they be Clojure <code>(fn [env data])</code>, and simply calls them with the contextual data for their location.</p>
</dd>
<dt class="hdlist1">External Event</dt>
<dd>
<p>An event that came from the external API, either by you calling <code>process-event</code> or some other actor code doing so (invocations, sends from external charts, etc.)</p>
</dd>
<dt class="hdlist1">Internal Event</dt>
<dd>
<p>An event that came from the session that will process it.
These come from the chart implementation itself (e.g. done evens) and from you using the <code>raise</code> element in an executable content position.</p>
</dd>
<dt class="hdlist1">EventQueue</dt>
<dd>
<p>A FIFO queue for external event delivery.
The event queue is responsible for holding onto pending External Events to "self", possibly other state chart sessions (instances of other charts), remote services (e.g. send an email), and for delayed delivery.
The default implementation is a "manually polled" queue that does <strong>not</strong> support most of these features, and the delayed event delivery is manual (e.g. you have to poll it, or ask it when the next one should happen and start a timer/thread).
Creating a system that runs the loop and does the timed delivery is typically how you would use these in a more serious/production environment.</p>
</dd>
<dt class="hdlist1">Processor</dt>
<dd>
<p>An implementation of the state chart algorithm.
This library comes with an implementation that follows (as closely as possible) the SCXML recommended standard from 2015. You may provide your own.</p>
</dd>
<dt class="hdlist1">InvocationProcessor</dt>
<dd>
<p>A protocol representing things that can be invoked while in a state.
Implementations are provided for state chart invocations, and (in CLJ) futures.
It is a simple matter to expand the list of supported types.</p>
</dd>
<dt class="hdlist1">WorkingMemoryStore</dt>
<dd>
<p>A protocol that represents a place to put the working memory of a state chart.
This is used when you want an autonomous system that can "freeze" and "thaw" running sessions as events are received.
Such a store could be in RAM (implementation provided) or in something more durable (Redis, SQL, Datomic, Filesystem).</p>
</dd>
<dt class="hdlist1">StatechartRegistry</dt>
<dd>
<p>A protocol that allows a state chart to be saved/retrieved by a well-known name.
An implementation is provided for tracking them in RAM, but you could also choose an execution model that allows your charts to be serializable, and then store the charts in something more durable.</p>
</dd>
<dt class="hdlist1">Session</dt>
<dd>
<p>The combination of the content of the DataModel and Working Memory.
I.e. the data you&#8217;d need in order to resume working from where you last left off.
Sessions typically have a unique ID, which could be used to store sessions into durable storage when they are "idle", and are used for cross-session events.</p>
</dd>
<dt class="hdlist1">Conditional Element</dt>
<dd>
<p>In state charts there is a node type (represented as a diamond) that represents a state in which the chart never "rests", but instead immediately transitions to another node based on predicate expressions.
In this library (and SCXML) this is modelled with a state that has more than one transition, NONE of which have and <code>:event</code> qualifier (meaning they are exited as soon as they are entered, assuming there is a valid transition).</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="_states"><a class="anchor" href="#_states"></a><a class="link" href="#_states">4.2. States</a></h3>
<div class="paragraph">
<p>States may be atomic, compound (hierarchical), or parallel.
The first two are generated with the <code>state</code> element, and the latter with <code>parallel</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_transitions"><a class="anchor" href="#_transitions"></a><a class="link" href="#_transitions">4.3. Transitions</a></h3>
<div class="paragraph">
<p>Transitions are the consumers of events.
Their "source" is their parent.
Transitions can be <strong>eventless</strong>, and they can also have no <strong>target</strong> (indicating they do not change the active states, and are only for executing their content).</p>
</div>
<div class="paragraph">
<p>A state can have any number of transition elements.
These are tested <strong>in order</strong> of appearance, and the first transition that matches the current circumstance is taken.
Transitions are <strong>enabled</strong> when:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Their <code>cond</code> (if present) evaluates to true AND</p>
</li>
<li>
<p>Their <code>event</code> (if present) matches the current event&#8217;s name (See event name matching)</p>
</li>
<li>
<p>OR neither are present.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A transition that is marked external and targets its enclosing state will cause the exit/entry handlers to fire.
An internal transition (that has no target at all) will not.</p>
</div>
<div class="paragraph">
<p>See the SCXML standard for other behaviors of <code>transition</code>.</p>
</div>
<div class="paragraph">
<p>See <a href="#Convenience">Shorthand Convenience</a> for some alternative ways to represent transitions that are easier to read.</p>
</div>
</div>
<div class="sect2">
<h3 id="_condition_states"><a class="anchor" href="#_condition_states"></a><a class="link" href="#_condition_states">4.4. "Condition" States</a></h3>
<div class="paragraph">
<p>Condition states from classic state charts (shown as a diamond in UML state chart notation) can be modelled using eventless transitions.</p>
</div>
<div class="paragraph">
<p>An "eventless" transition without a <code>:cond</code> is always enabled.</p>
</div>
<div class="paragraph">
<p>Below is a conditional state that when entered will immediately transition to either state :X or :Y, depending on the result of the first transition&#8217;s condition expression:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(state {<span class="symbol">:id</span> <span class="symbol">:Z</span>}
  (transition {<span class="symbol">:cond</span> positive-balance? <span class="symbol">:target</span> <span class="symbol">:X</span>})
  (transition {<span class="symbol">:target</span> <span class="symbol">:Y</span>}))</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
See <a href="#Convenience">Shorthand Convenience</a> for a nicer-looking version of this.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_flow_control_elements"><a class="anchor" href="#_flow_control_elements"></a><a class="link" href="#_flow_control_elements">4.5. Flow Control Elements</a></h3>
<div class="paragraph">
<p>The SCXML standard (Section 3.12) defines flow control elements for conditional branching and iteration within executable content.
This library provides native Clojure function equivalents:</p>
</div>
<div class="sect3">
<h4 id="_if_elseif_else"><a class="anchor" href="#_if_elseif_else"></a><a class="link" href="#_if_elseif_else">4.5.1. If / elseif / else</a></h4>
<div class="paragraph">
<p>Use <code>If</code> (capitalized to avoid collision with <code>clojure.core/if</code>), <code>elseif</code>, and <code>else</code> for multi-way branching inside executable content such as <code>on-entry</code>, <code>on-exit</code>, or <code>transition</code> bodies.</p>
</div>
<div class="paragraph">
<p>The <code>:cond</code> on <code>If</code> and <code>elseif</code> is an expression compatible with your execution model (typically
<code>(fn [env data] &#8230;&#8203;)</code> returning a truthy value).
Children before the first <code>elseif</code> or <code>else</code>
form the "then" branch:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(on-entry {}
  (assign {<span class="symbol">:location</span> [<span class="symbol">:x</span>] <span class="symbol">:expr</span> <span class="integer">2</span>})
  (If {<span class="symbol">:cond</span> (<span class="keyword">fn</span> [_ data] (<span class="keyword">=</span> (<span class="symbol">:x</span> data) <span class="integer">1</span>))}
    (assign {<span class="symbol">:location</span> [<span class="symbol">:result</span>] <span class="symbol">:expr</span> <span class="symbol">:first</span>})
    (elseif {<span class="symbol">:cond</span> (<span class="keyword">fn</span> [_ data] (<span class="keyword">=</span> (<span class="symbol">:x</span> data) <span class="integer">2</span>))}
      (assign {<span class="symbol">:location</span> [<span class="symbol">:result</span>] <span class="symbol">:expr</span> <span class="symbol">:second</span>}))
    (elseif {<span class="symbol">:cond</span> (<span class="keyword">fn</span> [_ data] (<span class="keyword">=</span> (<span class="symbol">:x</span> data) <span class="integer">3</span>))}
      (assign {<span class="symbol">:location</span> [<span class="symbol">:result</span>] <span class="symbol">:expr</span> <span class="symbol">:third</span>}))
    (else {}
      (assign {<span class="symbol">:location</span> [<span class="symbol">:result</span>] <span class="symbol">:expr</span> <span class="symbol">:default</span>}))))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each branch can contain any executable content (including nested <code>If</code> statements). This is
particularly useful for leveraging nested <code>raise</code>, allowing you to conditionally queue events
on the internal queue without having the write a script or use the external queue.</p>
</div>
</div>
<div class="sect3">
<h4 id="_foreach"><a class="anchor" href="#_foreach"></a><a class="link" href="#_foreach">4.5.2. foreach</a></h4>
<div class="paragraph">
<p>Use <code>foreach</code> to iterate over a collection, executing children for each item:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>:array</code>  An expression returning the collection to iterate over</p>
</li>
<li>
<p><code>:item</code>  A location (keyword or vector) where the current item is bound</p>
</li>
<li>
<p><code>:index</code>  (optional) A location where the current zero-based index is bound</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(on-entry {}
  (assign {<span class="symbol">:location</span> [<span class="symbol">:evens</span>] <span class="symbol">:expr</span> []})
  (foreach {<span class="symbol">:array</span> (<span class="keyword">fn</span> [_ _] [<span class="integer">1</span> <span class="integer">2</span> <span class="integer">3</span> <span class="integer">4</span> <span class="integer">5</span> <span class="integer">6</span>])
            <span class="symbol">:item</span>  [<span class="symbol">:n</span>]}
    (If {<span class="symbol">:cond</span> (<span class="keyword">fn</span> [_ data] (<span class="keyword">even?</span> (<span class="symbol">:n</span> data)))}
      (assign {<span class="symbol">:location</span> [<span class="symbol">:evens</span>]
               <span class="symbol">:expr</span>     (<span class="keyword">fn</span> [_ data]
                           (<span class="keyword">conj</span> (<span class="symbol">:evens</span> data) (<span class="symbol">:n</span> data)))}))))</code></pre>
</div>
</div>
<div class="paragraph">
<p>An empty collection simply skips the body. <code>foreach</code> and <code>If</code> can be freely nested.</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_in_predicate"><a class="anchor" href="#_the_in_predicate"></a><a class="link" href="#_the_in_predicate">4.5.3. The <code>In</code> Predicate</a></h4>
<div class="paragraph">
<p>The W3C SCXML standard defines an <code>In()</code> predicate (Section 5.9) for checking whether a state is in the current configuration.
This library provides <code>In</code> as a function that returns a predicate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(transition {<span class="symbol">:event</span> <span class="symbol">:check</span> <span class="symbol">:target</span> <span class="symbol">:next</span> <span class="symbol">:cond</span> (In <span class="symbol">:some-state</span>)})</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>(In :some-state)</code> returns a <code>(fn [env data] &#8230;&#8203;)</code> that checks whether <code>:some-state</code> is in the active configuration.
This is useful for guards on transitions in parallel state charts where you need to coordinate across regions.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_event_processing"><a class="anchor" href="#_event_processing"></a><a class="link" href="#_event_processing">4.6. Event Processing</a></h3>
<div class="paragraph">
<p>In a fully-fleshed system your event queue would have a corresponding runtime story, where <code>process-event</code> was automatically called on the correct chart/session/invocation/service when an event is available.
As such, and event queue might be distributed and durable (e.g. using Kafka or the like), or might simply be something that runs in-core (a core.async <code>go-loop</code>).</p>
</div>
<div class="paragraph">
<p>The library includes a fully-functional system for simple applications in the <code>simple</code> namespace.</p>
</div>
<div class="sect3">
<h4 id="_event_name_matching"><a class="anchor" href="#_event_name_matching"></a><a class="link" href="#_event_name_matching">4.6.1. Event Name Matching</a></h4>
<div class="paragraph">
<p>The SCXML standard describes a name matching algorithm for event names that allows for wildcard pattern matching.
Event names are dot-separated, and are prefix-matched.
In this library keywords are used for event names, but other than that the interpretation is as specified in the standard.
For example, the event name <code>:a.b.c</code> is matched by <code>:a.b.c.*</code>, <code>:a.b.c</code>, <code>:a.b.*</code>, <code>:a.b</code>, etc.
That is to say that a transition with <code>:event :a.b</code> would be enabled by event <code>:a.b.c</code>.</p>
</div>
<div class="paragraph">
<p>The wildcard is always implied, but can be specified on a transition for clarity.
Transitions are enabled and matched "in order", so you can model narrowed and catch-all behavior:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(state {<span class="symbol">:id</span> A}
  (transition {<span class="symbol">:event</span> <span class="symbol">:error.communication</span>} <span class="keyword">..</span><span class="keyword">.</span>)
  (transition {<span class="symbol">:event</span> <span class="symbol">:error</span>} <span class="keyword">..</span><span class="keyword">.</span>))</code></pre>
</div>
</div>
<div class="paragraph">
<p>where the first transition will be enabled only if the error is a communication one, and all errors will enable the second.</p>
</div>
<div class="paragraph">
<p>See the SCXML standard for the rules on transition preemption regarding conflicting transitions that match at the same time.</p>
</div>
</div>
<div class="sect3">
<h4 id="_send_targets"><a class="anchor" href="#_send_targets"></a><a class="link" href="#_send_targets">4.6.2. Send Targets</a></h4>
<div class="paragraph">
<p>The SCXML standard (section 6.2.4) allows the format of the target to change based on the type, and implies that these are often URLs.
The default implementation of the event queue in this library only supports targeting other state charts (see Send Types below), and when using the default send type, the target is expected to simply be a <code>session-id</code>, where <code>session-id</code>  is a unique identifier, such as a GUUID.</p>
</div>
<div class="paragraph">
<p>Other implementations of the EventQueue protocol may choose to define further refinements.</p>
</div>
</div>
<div class="sect3">
<h4 id="_send_types"><a class="anchor" href="#_send_types"></a><a class="link" href="#_send_types">4.6.3. Send Types</a></h4>
<div class="paragraph">
<p>The SCXML standard (section 6.2.5) defines types as a URI as well.
The internal implementations in this library do not enforce this, but this library <strong>does</strong> recognize the string "http://www.w3.org/TR/scxml/#SCXMLEventProcessor"
as a desire to talk to another state chart session (and is the only/default predefined value).</p>
</div>
</div>
<div class="sect3">
<h4 id="_manual_polling_queue"><a class="anchor" href="#_manual_polling_queue"></a><a class="link" href="#_manual_polling_queue">4.6.4. Manual Polling Queue</a></h4>
<div class="paragraph">
<p>There is a manually polled queue implementation in this library, with <strong>no</strong> automatic processing at all.
If you want to support events that come from outside of the chart via the queue, then you have to create a loop that polls the queue and calls <code>process-event!</code>.
If you do this, then event the delayed event delivery will work, as long as your code watches for the delayed events to appear on the queue.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">traffic-light</span>
  (<span class="symbol">:require</span>
    [com.fulcrologic.statecharts <span class="symbol">:as</span> sc]
    [com.fulcrologic.statecharts.chart <span class="symbol">:refer</span> [statechart]]
    [com.fulcrologic.statecharts.elements <span class="symbol">:refer</span> [parallel state transition]]
    [com.fulcrologic.statecharts.events <span class="symbol">:refer</span> [new-event]]
    [com.fulcrologic.statecharts.protocols <span class="symbol">:as</span> sp]
    [com.fulcrologic.statecharts.simple <span class="symbol">:as</span> simple]
    [com.fulcrologic.statecharts.util <span class="symbol">:refer</span> [extend-key]]))

(<span class="keyword">def</span> <span class="function">nk</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">(nk :a </span><span class="content">\&quot;</span><span class="content">b</span><span class="content">\&quot;</span><span class="content">) =&gt; :a/b
   (nk :a/b </span><span class="content">\&quot;</span><span class="content">c</span><span class="content">\&quot;</span><span class="content">) =&gt; :a.b/c</span><span class="delimiter">&quot;</span></span>
  extend-key)

(<span class="keyword">defn</span> <span class="function">traffic-signal</span> [id initial]
  (<span class="keyword">let</span> [red     (nk id <span class="string"><span class="delimiter">&quot;</span><span class="content">red</span><span class="delimiter">&quot;</span></span>)
        yellow  (nk id <span class="string"><span class="delimiter">&quot;</span><span class="content">yellow</span><span class="delimiter">&quot;</span></span>)
        green   (nk id <span class="string"><span class="delimiter">&quot;</span><span class="content">green</span><span class="delimiter">&quot;</span></span>)
        initial (nk id (<span class="keyword">name</span> initial))]
    (state {<span class="symbol">:id</span>      id
            <span class="symbol">:initial</span> initial}
      (state {<span class="symbol">:id</span> red}
        (transition {<span class="symbol">:event</span> <span class="symbol">:swap-flow</span> <span class="symbol">:target</span> green}))
      (state {<span class="symbol">:id</span> yellow}
        (transition {<span class="symbol">:event</span> <span class="symbol">:swap-flow</span> <span class="symbol">:target</span> red}))
      (state {<span class="symbol">:id</span> green}
        (transition {<span class="symbol">:event</span>  <span class="symbol">:warn-traffic</span>
                     <span class="symbol">:target</span> yellow})))))

(<span class="keyword">defn</span> <span class="function">ped-signal</span> [id initial]
  (<span class="keyword">let</span> [red            (nk id <span class="string"><span class="delimiter">&quot;</span><span class="content">red</span><span class="delimiter">&quot;</span></span>)
        flashing-white (nk id <span class="string"><span class="delimiter">&quot;</span><span class="content">flashing-white</span><span class="delimiter">&quot;</span></span>)
        white          (nk id <span class="string"><span class="delimiter">&quot;</span><span class="content">white</span><span class="delimiter">&quot;</span></span>)
        initial        (nk id (<span class="keyword">name</span> initial))]
    (state {<span class="symbol">:id</span>      id
            <span class="symbol">:initial</span> initial}
      (state {<span class="symbol">:id</span> red}
        (transition {<span class="symbol">:event</span> <span class="symbol">:swap-flow</span> <span class="symbol">:target</span> white}))
      (state {<span class="symbol">:id</span> flashing-white}
        (transition {<span class="symbol">:event</span> <span class="symbol">:swap-flow</span> <span class="symbol">:target</span> red}))
      (state {<span class="symbol">:id</span> white}
        (transition {<span class="symbol">:event</span> <span class="symbol">:warn-pedestrians</span> <span class="symbol">:target</span> flashing-white})))))

(<span class="keyword">def</span> <span class="function">traffic-lights</span>
  (statechart {}
    (parallel {}
      (traffic-signal <span class="symbol">:east-west</span> <span class="symbol">:green</span>)
      (traffic-signal <span class="symbol">:north-south</span> <span class="symbol">:red</span>)

      (ped-signal <span class="symbol">:cross-ew</span> <span class="symbol">:red</span>)
      (ped-signal <span class="symbol">:cross-ns</span> <span class="symbol">:white</span>))))

(<span class="keyword">defn</span> <span class="function">show-states</span> [wmem]
  (<span class="keyword">println</span>
    (<span class="keyword">sort</span>
      (<span class="keyword">filter</span> #{<span class="symbol">:north-south/red</span>
                <span class="symbol">:north-south/yellow</span>
                <span class="symbol">:north-south/green</span>
                <span class="symbol">:east-west/red</span>
                <span class="symbol">:east-west/yellow</span>
                <span class="symbol">:east-west/green</span>
                <span class="symbol">:cross-ns/red</span>
                <span class="symbol">:cross-ns/white</span>
                <span class="symbol">:cross-ns/flashing-white</span>
                <span class="symbol">:cross-ew/red</span>
                <span class="symbol">:cross-ew/white</span>
                <span class="symbol">:cross-ew/flashing-white</span>}
        (<span class="symbol">::sc/configuration</span> wmem)))))

(<span class="keyword">def</span> <span class="function">env</span> (simple/simple-env))
(simple/register! env <span class="symbol">::lights</span> traffic-lights)
(<span class="keyword">def</span> <span class="function">processor</span> (<span class="symbol">::sc/processor</span> env))
(<span class="keyword">def</span> <span class="function">s0</span> (sp/start! processor env <span class="symbol">::lights</span> {<span class="symbol">::sc/session-id</span> <span class="integer">1</span>}))
(show-states s0)
(<span class="keyword">def</span> <span class="function">s1</span> (sp/process-event! processor env s0 (new-event <span class="symbol">:warn-pedestrians</span>)))
(show-states s1)
(<span class="keyword">def</span> <span class="function">s2</span> (sp/process-event! processor env s1 (new-event <span class="symbol">:warn-traffic</span>)))
(show-states s2)
(<span class="keyword">def</span> <span class="function">s3</span> (sp/process-event! processor env s2 (new-event <span class="symbol">:swap-flow</span>)))
(show-states s3)
(<span class="keyword">def</span> <span class="function">s4</span> (sp/process-event! processor env s3 (new-event <span class="symbol">:warn-pedestrians</span>)))
(show-states s4)
(<span class="keyword">def</span> <span class="function">s5</span> (sp/process-event! processor env s4 (new-event <span class="symbol">:warn-traffic</span>)))
(show-states s5)
(<span class="keyword">def</span> <span class="function">s6</span> (sp/process-event! processor env s5 (new-event <span class="symbol">:swap-flow</span>)))
(show-states s6)</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_data_models"><a class="anchor" href="#_data_models"></a><a class="link" href="#_data_models">4.7. Data Models</a></h3>
<div class="paragraph">
<p>A data model is a component of the system that holds data for a given state chart&#8217;s session.
The SCXML specification allows the implementation quite a bit of latitude in the interpretation of the chart&#8217;s data model.
You could define scopes that nest, one global map of data that is visible everywhere, or hook your data model to an external database.</p>
</div>
<div class="paragraph">
<p>See the docstrings in the <code>protocols</code> namespace.</p>
</div>
<div class="paragraph">
<p>There is a predefined <code>FlatWorkingMemoryDataModel</code> (in <code>data-model.working-memory-data-model</code>) that puts all data into a single scope (a map which itself can be a nested data structure).
This is the recommended model for ease of use.</p>
</div>
<div class="paragraph">
<p>There is also a predefined <code>WorkingMemoryDataModel</code> in that scopes data to the state in which it is declared.</p>
</div>
<div class="paragraph">
<p>Both of these put the real data in the session working memory, allowing the data, for example, to be persisted with the state of a running session when pausing it for later revival.</p>
</div>
</div>
<div class="sect2">
<h3 id="_execution_models"><a class="anchor" href="#_execution_models"></a><a class="link" href="#_execution_models">4.8. Execution Models</a></h3>
<div class="paragraph">
<p>Most people will probably just use the CLJCExecutionModel, which lets you write executable content in CLJC as lambdas:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="comment">;; Use `data` to compute when this transition is &quot;enabled&quot;</span>
(transition {<span class="symbol">:event</span> <span class="symbol">:a</span> <span class="symbol">:cond</span> (<span class="keyword">fn</span> [env data] (your-predicate data))}
  <span class="comment">;; Run some arbitrary code on this transition</span>
  (script {<span class="symbol">:expr</span> (<span class="keyword">fn</span> [env data] <span class="keyword">..</span><span class="keyword">.</span>)}))</code></pre>
</div>
</div>
<div class="paragraph">
<p>There is a macro version of the <code>script</code> element called <code>script-fn</code> that can be used as a shorthand for script elements:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="comment">;; Use `data` to compute when this transition is &quot;enabled&quot;</span>
(transition {<span class="symbol">:event</span> <span class="symbol">:a</span> <span class="symbol">:cond</span> (<span class="keyword">fn</span> [env data] (your-predicate data))}
  <span class="comment">;; Run some arbitrary code on this transition</span>
  (script-fn [env data] <span class="keyword">..</span><span class="keyword">.</span>)))</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_working_memory_and_identity"><a class="anchor" href="#_working_memory_and_identity"></a><a class="link" href="#_working_memory_and_identity">4.9. Working Memory and Identity</a></h3>
<div class="paragraph">
<p>The working memory of the state chart is plain EDN and contains no code.
It is serializable by nippy, transit, etc.
Therefore, you can easily save an active state chart by value into any data store.
The value is intended to be as small as possible so that storage can be efficient.</p>
</div>
<div class="paragraph">
<p>Every active state chart is assigned a ID on creation (which you can override via <code>initialize</code>).
This is intended as part of the story to allow you to coordinate external event sources with working with instances of chart that are archived in durable storage while idle.</p>
</div>
</div>
<div class="sect2">
<h3 id="_accessing_running_charts_from_outside_the_chart"><a class="anchor" href="#_accessing_running_charts_from_outside_the_chart"></a><a class="link" href="#_accessing_running_charts_from_outside_the_chart">4.10. Accessing Running Charts from Outside the Chart</a></h3>
<div class="paragraph">
<p>While you <strong>can</strong> work with the core algorithms as pure function, you will normally set up a standard system environment (where you provide an event queue and working memory store).
When working with such a system you may have many charts running (stored in the working memory store) and can send them events via the event queue.</p>
</div>
<div class="paragraph">
<p>The <code>com.fulcrologic.statecharts.runtime</code> namespace includes functions which can be used to work with such a system from <strong>outside</strong> the chart itself.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>current-configuration</code></dt>
<dd>
<p>Get the set of active states for by session id.</p>
</dd>
<dt class="hdlist1"><code>processing-env</code></dt>
<dd>
<p>Get a processing env (using a system env and session id)</p>
</dd>
<dt class="hdlist1"><code>session-data</code></dt>
<dd>
<p>Get internal state chart data from a particular state chart session.</p>
</dd>
<dt class="hdlist1"><code>send!</code></dt>
<dd>
<p>Send an event.
The simple system has this function as well, and it is a standard part of the protocols, but this wrapper makes it a little more convenient to use when you already have a system env map.</p>
</dd>
</dl>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
Beware the term "env".
In this library a system environment is a map that contains a key for the various components of the system (e.g. the event queue, processor, execution model, etc.).
A <strong>processing env</strong> is an system environment <em>which also includes</em> the current details of a <strong>particular session</strong> and is the <code>env</code> you see in the lambdas in your chart.
The latter <strong>can</strong> be used anywhere the former is needed, but not vice-versa.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_invocations"><a class="anchor" href="#_invocations"></a><a class="link" href="#_invocations">4.11. Invocations</a></h3>
<div class="paragraph">
<p>An invocation is an "external" service/chart/process that can be started when your state chart enters a state, exchanges events <strong>while</strong> that state is active (you can forward events and receive them).
The invocation can self-terminate while the state is still active, but it will also be cancelled if your chart leaves the enclosing state.</p>
</div>
<div class="paragraph">
<p>Invocations can forward events to the target invocation, and can receive events back.
An incoming event will be pre-processed by <code>finalize</code> elements and can update the data model before the event is further propagated through the chart.
See the SCXML standard for a full description of how invocations work.</p>
</div>
<div class="sect3">
<h4 id="_passing_invocation_data"><a class="anchor" href="#_passing_invocation_data"></a><a class="link" href="#_passing_invocation_data">4.11.1. Passing Invocation Data</a></h4>
<div class="paragraph">
<p>The <code>invoke</code> element has both a <code>:namelist</code> and <code>:params</code> argument.
The former allows you to list data locations of the parent that should be copied to the child. <code>:params</code> is dynamic, and allows you to specify expressions that calculate values to inject into the child data model.
These options can be used together, with params taking precedence.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(invoke {<span class="symbol">:namelist</span> {[<span class="symbol">:area</span> <span class="symbol">:x</span>] [<span class="symbol">:target</span> <span class="symbol">:y</span>]}
         <span class="symbol">:params</span> (<span class="keyword">fn</span> [env data] {[<span class="symbol">:other</span> <span class="symbol">:y</span>] <span class="integer">42</span>
         <span class="keyword">..</span><span class="keyword">.</span>})</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_invoking_other_state_charts_or_futures"><a class="anchor" href="#_invoking_other_state_charts_or_futures"></a><a class="link" href="#_invoking_other_state_charts_or_futures">4.11.2. Invoking other State Charts or Futures</a></h4>
<div class="paragraph">
<p>The library has a built-in <code>InvocationProcessor</code> that knows how to start other state charts via an <code>invoke</code>, and in CLJ there is also support for futures (which are cancelled if the state containing the invoke is exited).</p>
</div>
<div class="paragraph">
<p>The <code>src/examples</code> of the repository includes an example, shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">invocations</span>
  (<span class="symbol">:require</span>
    [com.fulcrologic.statecharts <span class="symbol">:as</span> sc]
    [com.fulcrologic.statecharts.algorithms.v20150901-validation <span class="symbol">:as</span> v]
    [com.fulcrologic.statecharts.chart <span class="symbol">:refer</span> [statechart]]
    [com.fulcrologic.statecharts.elements <span class="symbol">:refer</span> [Send data-model final invoke log on-entry on-exit state transition]]
    [com.fulcrologic.statecharts.environment <span class="symbol">:as</span> e]
    [com.fulcrologic.statecharts.event-queue.core-async-event-loop <span class="symbol">:as</span> <span class="keyword">loop</span>]
    [com.fulcrologic.statecharts.simple <span class="symbol">:as</span> simple]
    [taoensso.timbre <span class="symbol">:as</span> log]))

(<span class="keyword">def</span> <span class="function">child-chart</span>
  (statechart {}
    (data-model {<span class="symbol">:x</span> <span class="integer">1</span>})
    (state {}                                               <span class="comment">; top-level state so we can log an exit from the overall machine</span>
      (on-exit {}
        (log {<span class="symbol">:level</span> <span class="symbol">:info</span>
              <span class="symbol">:label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">CHILD CHART EXIT</span><span class="delimiter">&quot;</span></span>}))

      (transition {<span class="symbol">:event</span>  <span class="symbol">:event/exit</span>
                   <span class="symbol">:target</span> <span class="symbol">:state/final</span>})

      (state {<span class="symbol">:id</span> <span class="symbol">:X</span>}
        (on-entry {}
          (log {<span class="symbol">:level</span> <span class="symbol">:info</span>
                <span class="symbol">:label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Child X</span><span class="delimiter">&quot;</span></span> <span class="symbol">:expr</span> (<span class="keyword">fn</span> [_ {<span class="symbol">:keys</span> [x]}] x)}))
        <span class="comment">;; NOTE: The future invocation processor is only coded for CLJ, so this invocation is ignored in CLJS</span>
        (invoke {<span class="symbol">:id</span>     <span class="symbol">:child/future</span>
                 <span class="symbol">:type</span>   <span class="symbol">:future</span>
                 <span class="symbol">:params</span> {<span class="symbol">:time</span> (<span class="keyword">fn</span> [_ {<span class="symbol">:keys</span> [x]}] x)}
                 <span class="symbol">:src</span>    (<span class="keyword">fn</span> [{<span class="symbol">:keys</span> [<span class="keyword">time</span>]}]
                           (log/info <span class="string"><span class="delimiter">&quot;</span><span class="content">Invocation running for</span><span class="delimiter">&quot;</span></span> <span class="keyword">time</span>)
                           <span class="error">#</span>?(<span class="symbol">:clj</span> (<span class="keyword">try</span>
                                     (Thread/sleep (<span class="keyword">long</span> (<span class="keyword">*</span> <span class="integer">1000</span> <span class="keyword">time</span>)))
                                     (<span class="keyword">catch</span> InterruptedException e
                                       (log/info <span class="string"><span class="delimiter">&quot;</span><span class="content">Future cancelled!</span><span class="delimiter">&quot;</span></span>)
                                       (<span class="keyword">throw</span> e))))
                           (log/info <span class="string"><span class="delimiter">&quot;</span><span class="content">Future function completed</span><span class="delimiter">&quot;</span></span>)
                           {<span class="symbol">:future-result</span> <span class="symbol">:DONE</span>})})
        (transition {<span class="symbol">:event</span> <span class="symbol">:done.invoke.*</span>}
          (log {<span class="symbol">:level</span> <span class="symbol">:info</span>
                <span class="symbol">:label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Future indicated that it completed</span><span class="delimiter">&quot;</span></span>
                <span class="symbol">:expr</span>  (<span class="keyword">fn</span> [e d]
                         (log/spy <span class="symbol">:debug</span> d))}))
        (transition {<span class="symbol">:event</span> <span class="symbol">:child/swap</span> <span class="symbol">:target</span> <span class="symbol">:Y</span>}))
      (state {<span class="symbol">:id</span> <span class="symbol">:Y</span>}
        (on-entry {}
          (log {<span class="symbol">:level</span> <span class="symbol">:info</span>
                <span class="symbol">:label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Child Y</span><span class="delimiter">&quot;</span></span>}))
        (on-exit {}
          (Send {<span class="symbol">:event</span>      <span class="symbol">:child.left-y</span>
                 <span class="symbol">:type</span>       <span class="symbol">::sc/chart</span>
                 <span class="symbol">:targetexpr</span> (<span class="keyword">fn</span> [env data]
                               (e/parent-session-id env))}))
        (transition {<span class="symbol">:event</span> <span class="symbol">:child/swap</span> <span class="symbol">:target</span> <span class="symbol">:X</span>})))
    (final {<span class="symbol">:id</span> <span class="symbol">:state/final</span>})))

(<span class="keyword">comment</span>
  (v/problems child-chart))

(<span class="keyword">def</span> <span class="function">main-chart</span>
  (statechart {}
    (state {<span class="symbol">:id</span> <span class="symbol">:A</span>}
      (on-entry {}
        (log {<span class="symbol">:level</span> <span class="symbol">:info</span>
              <span class="symbol">:label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Main A</span><span class="delimiter">&quot;</span></span>}))
      (transition {<span class="symbol">:event</span> <span class="symbol">:swap</span> <span class="symbol">:target</span> <span class="symbol">:B</span>}))
    (state {<span class="symbol">:id</span> <span class="symbol">:B</span>}
      (on-entry {}
        (log {<span class="symbol">:level</span> <span class="symbol">:info</span>
              <span class="symbol">:label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Main B</span><span class="delimiter">&quot;</span></span>}))
      (transition {<span class="symbol">:event</span> <span class="symbol">:swap</span> <span class="symbol">:target</span> <span class="symbol">:A</span>})
      (transition {<span class="symbol">:event</span> <span class="symbol">:child.*</span>}
        (log {<span class="symbol">:level</span> <span class="symbol">:info</span>
              <span class="symbol">:label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Child event</span><span class="delimiter">&quot;</span></span> <span class="symbol">:expr</span> (<span class="keyword">fn</span> [_ data] data)}))
      (invoke {<span class="symbol">:id</span>          <span class="symbol">:main/child</span>
               <span class="symbol">:autoforward</span> <span class="predefined-constant">true</span>                            <span class="comment">; be careful, sends all events through, but it is possible to cause infinite loops if child sends events in response</span>
               <span class="symbol">:type</span>        <span class="symbol">:statechart</span>
               <span class="symbol">:src</span>         `child-chart
               <span class="symbol">:params</span>      {<span class="symbol">:x</span> <span class="integer">10</span>}
               <span class="symbol">:finalize</span>    (<span class="keyword">fn</span> [env data]
                              (log/info <span class="string"><span class="delimiter">&quot;</span><span class="content">Event from child to parent: </span><span class="delimiter">&quot;</span></span> data))}))))

(<span class="keyword">comment</span>
  (<span class="keyword">do</span>
    (log/set-level! <span class="symbol">:info</span>)                                  <span class="comment">; so we can see log elements</span>
    (<span class="keyword">def</span> <span class="function">session-id</span> <span class="integer">42</span>)
    (<span class="keyword">def</span> <span class="function">env</span> (simple/simple-env))
    (simple/register! env `main-chart main-chart)
    (simple/register! env `child-chart child-chart)
    (<span class="keyword">def</span> <span class="function">running?</span> (loop/run-event-loop! env <span class="integer">100</span>))
    (simple/start! env `main-chart session-id))

  <span class="comment">;; Sending this multiple times with swap main chart states. When in B, a child chart will start.</span>
  (simple/send! env {<span class="symbol">:target</span> session-id
                     <span class="symbol">:event</span>  <span class="symbol">:swap</span>})

  (<span class="symbol">::sc/working-memory-store</span> env)
  <span class="comment">;; With autoforward on, we can ferry events though to the child</span>
  (simple/send! env {<span class="symbol">:target</span> session-id
                     <span class="symbol">:event</span>  <span class="symbol">:child/swap</span>})

  <span class="comment">;; When the child chart is running (top chart is in :B), You can send it events.</span>
  <span class="comment">;; The session ID of a child session will be the ID of the node, of if you don't supply one an autogenerated</span>
  <span class="comment">;; one will be stored at idlocation with the string value &lt;parent-session-ID `.` &lt;generated-id&gt;</span>
  (simple/send! env {<span class="symbol">:target</span> <span class="symbol">:main/child</span>
                     <span class="symbol">:event</span>  <span class="symbol">:child/swap</span>})

  (simple/send! env {<span class="symbol">:target</span> <span class="symbol">:main/child</span>
                     <span class="symbol">:event</span>  <span class="symbol">:event/exit</span>})

  <span class="comment">;; terminate the event loop</span>
  (<span class="keyword">reset!</span> running? <span class="predefined-constant">false</span>))</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_custom_invocation_processors"><a class="anchor" href="#_custom_invocation_processors"></a><a class="link" href="#_custom_invocation_processors">4.11.3. Custom Invocation Processors</a></h4>
<div class="paragraph">
<p>For example, suppose you want to install an invocation processor that can provide timer events on some interval.
You could do something like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">custom-invocation</span>
  (<span class="symbol">:require</span>
    [clojure.core.async <span class="symbol">:as</span> async]
    [com.fulcrologic.statecharts <span class="symbol">:as</span> sc]
    [com.fulcrologic.statecharts.chart <span class="symbol">:refer</span> [statechart]]
    [com.fulcrologic.statecharts.data-model.operations <span class="symbol">:as</span> ops]
    [com.fulcrologic.statecharts.elements <span class="symbol">:refer</span> [invoke script-fn state transition]]
    [com.fulcrologic.statecharts.environment <span class="symbol">:as</span> env]
    [com.fulcrologic.statecharts.event-queue.core-async-event-loop <span class="symbol">:as</span> <span class="keyword">loop</span>]
    [com.fulcrologic.statecharts.events <span class="symbol">:as</span> evts]
    [com.fulcrologic.statecharts.protocols <span class="symbol">:as</span> sp]
    [com.fulcrologic.statecharts.simple <span class="symbol">:as</span> simple]
    [taoensso.timbre <span class="symbol">:as</span> log]))

(<span class="keyword">deftype</span> Timer [active-invocations]
  sp/InvocationProcessor
  (supports-invocation-type? [_this typ] (<span class="keyword">=</span> typ <span class="symbol">:timer</span>))
  (start-invocation! [_this {<span class="symbol">::sc/keys</span> [event-queue]
                             <span class="symbol">:as</span>       env} {<span class="symbol">:keys</span> [invokeid params]}]
    (<span class="keyword">let</span> [source-session-id (env/session-id env)
          {<span class="symbol">:keys</span> [interval]
           <span class="symbol">:or</span>   {interval <span class="integer">1000</span>}} params
          time-id           (<span class="keyword">str</span> source-session-id <span class="string"><span class="delimiter">&quot;</span><span class="content">.</span><span class="delimiter">&quot;</span></span> invokeid)
          notify!           (<span class="keyword">fn</span> []
                              (log/info <span class="string"><span class="delimiter">&quot;</span><span class="content">sending notification</span><span class="delimiter">&quot;</span></span>)
                              (sp/send! event-queue env
                                {<span class="symbol">:target</span>            source-session-id
                                 <span class="symbol">:send-id</span>           time-id
                                 <span class="comment">;; IMPORTANT: If you don't include the invokeid, then it won't register in finalize</span>
                                 <span class="symbol">:invoke-id</span>         invokeid
                                 <span class="symbol">:source-session-id</span> time-id
                                 <span class="symbol">:event</span>             <span class="symbol">:interval-timer/timeout</span>}))]
      (<span class="keyword">swap!</span> active-invocations <span class="keyword">assoc</span> time-id <span class="predefined-constant">true</span>)
      (async/go-loop []
        (async/&lt;! (async/timeout interval))
        (<span class="keyword">if</span> (<span class="keyword">get</span> @active-invocations time-id)
          (<span class="keyword">do</span>
            (notify!)
            (<span class="keyword">recur</span>))
          (log/info <span class="string"><span class="delimiter">&quot;</span><span class="content">Timer loop exited</span><span class="delimiter">&quot;</span></span>)))
      <span class="predefined-constant">true</span>))
  (stop-invocation! [_ env {<span class="symbol">:keys</span> [invokeid] <span class="symbol">:as</span> data}]
    (log/spy <span class="symbol">:info</span> data)
    (log/info <span class="string"><span class="delimiter">&quot;</span><span class="content">Invocation</span><span class="delimiter">&quot;</span></span> invokeid <span class="string"><span class="delimiter">&quot;</span><span class="content">asked to stop</span><span class="delimiter">&quot;</span></span>)
    (<span class="keyword">let</span> [source-session-id (env/session-id env)
          time-id           (<span class="keyword">str</span> source-session-id <span class="string"><span class="delimiter">&quot;</span><span class="content">.</span><span class="delimiter">&quot;</span></span> invokeid)]
      (<span class="keyword">swap!</span> active-invocations <span class="keyword">dissoc</span> time-id)
      <span class="predefined-constant">true</span>))
  (forward-event! [_this _env _event] <span class="predefined-constant">nil</span>))

(<span class="keyword">defn</span> <span class="function">new-timer-service</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Create a new time service that can be invoked from a state chart.</span><span class="delimiter">&quot;</span></span>
  [] (-&gt;Timer (<span class="keyword">atom</span> {})))

(<span class="keyword">def</span> <span class="function">demo-chart</span>
  (statechart {}
    (state {<span class="symbol">:id</span> <span class="symbol">:A</span>}
      (transition {<span class="symbol">:event</span> <span class="symbol">:swap</span> <span class="symbol">:target</span> <span class="symbol">:B</span>}))
    (state {<span class="symbol">:id</span> <span class="symbol">:B</span>}
      (transition {<span class="symbol">:event</span> <span class="symbol">:swap</span> <span class="symbol">:target</span> <span class="symbol">:A</span>})
      (transition {<span class="symbol">:event</span> <span class="symbol">:interval-timer/timeout</span>}
        (script-fn [_ data] (log/info <span class="string"><span class="delimiter">&quot;</span><span class="content">Main transition got data</span><span class="delimiter">&quot;</span></span> (<span class="keyword">select-keys</span> data [<span class="symbol">:B</span> <span class="symbol">:timer-calls</span>]))))

      (invoke {<span class="symbol">:idlocation</span> [<span class="symbol">:B</span> <span class="symbol">:invocation-id</span>]
               <span class="symbol">:type</span>       <span class="symbol">:timer</span>
               <span class="symbol">:params</span>     {<span class="symbol">:interval</span> <span class="integer">500</span>}
               <span class="symbol">:finalize</span>   (<span class="keyword">fn</span> [_env {<span class="symbol">:keys</span> [_event timer-calls]}]
                             (log/info <span class="string"><span class="delimiter">&quot;</span><span class="content">Finalize got timer calls data: </span><span class="delimiter">&quot;</span></span> [timer-calls _event])
                             <span class="comment">;; Finalize gets to update the model before the event is delivered...</span>
                             [(ops/assign <span class="symbol">:timer-calls</span> (<span class="keyword">inc</span> (<span class="keyword">or</span> timer-calls <span class="integer">0</span>)))])}))))

(<span class="keyword">comment</span>
  (<span class="keyword">do</span>
    (<span class="keyword">def</span> <span class="function">env</span> (simple/simple-env {<span class="symbol">::sc/invocation-processors</span> [(new-timer-service)]}))
    (simple/register! env `demo-chart demo-chart)
    (<span class="keyword">def</span> <span class="function">queue</span> (<span class="symbol">::sc/event-queue</span> env))
    (<span class="keyword">def</span> <span class="function">processor</span> (<span class="symbol">::sc/processor</span> env))
    (<span class="keyword">def</span> <span class="function">session-id</span> <span class="integer">42</span>)
    (<span class="keyword">def</span> <span class="function">wmem</span> (<span class="keyword">atom</span> {}))
    (<span class="keyword">def</span> <span class="function">running?</span> (loop/run-event-loop! env <span class="integer">100</span>)))

  (simple/start! env `demo-chart session-id)

  <span class="comment">;; Send this one multiple times</span>
  (simple/send! env {<span class="symbol">:target</span> session-id
                     <span class="symbol">:event</span>  <span class="symbol">:swap</span>})

  <span class="comment">;; Send this one to exit the top level machine</span>
  (simple/send! env {<span class="symbol">:target</span> session-id
                     <span class="symbol">:event</span>  evts/cancel-event})

  <span class="comment">;; stop the event loop</span>
  (<span class="keyword">reset!</span> running? <span class="predefined-constant">false</span>)
  )</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>transition</code> element responds to the events received by the state chart, and the invocation processor for an <code>invoke</code> can send such events.
So, the timer service here is sending <code>:interval-timer/timeout</code> events.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Convenience"><a class="anchor" href="#Convenience"></a><a class="link" href="#Convenience">5. Shorthand Convenience</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Making your state chart definition cleaner is a simple matter, since it is nothing more than a nested data structure.</p>
</div>
<div class="paragraph">
<p>One thing to note is that every element of the state chart can accept a nested sequence of children, and it will automatically flatten them.
This means you can write helper functions that emit sequences of children, which in turn can use other helpers that might emit sequences.</p>
</div>
<div class="paragraph">
<p>Thus, macros and functions can be used to generate common patterns.
The <code>convenience</code> and
<code>convenience-macros</code> nses define some examples.
These two namespaces are currently ALPHA and are not API stable, but it is a simple matter to copy their content if you like any of them and want to rely on them.</p>
</div>
<div class="paragraph">
<p>The macro versions expect you to be using the lambda execution model, and require that you use a symbol for the expression (that resolves to a function).
They add some additional <code>:diagram/???</code> attributes to the elements that are string versions of the expression, for use in diagram tools or possibly even export.</p>
</div>
<div class="paragraph">
<p>One common pattern is to schedule a delayed event on entry to a state, but cancel (if non-delivered) on exit.
This helper exists in <code>convenience</code>, and looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">defn</span> <span class="function">send-after</span>
  [{<span class="symbol">:keys</span> [id <span class="keyword">delay</span> delayexpr] <span class="symbol">:as</span> send-props}]
  (<span class="keyword">when-not</span> id (<span class="keyword">throw</span> (IllegalArgumentException. <span class="string"><span class="delimiter">&quot;</span><span class="content">send-after's props MUST include an :id.</span><span class="delimiter">&quot;</span></span>)))
  [(on-entry {}
     (Send send-props))
   (on-exit {}
     (cancel {<span class="symbol">:sendid</span> id}))])</code></pre>
</div>
</div>
<div class="paragraph">
<p>There are also some simple ones (as functions) that clean up readability for common cases:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(transition {<span class="symbol">:event</span> <span class="symbol">:E</span> <span class="symbol">:target</span> <span class="symbol">:target-state</span>}
  optional-executable-elements <span class="keyword">..</span><span class="keyword">.</span>)

<span class="comment">;; has a convenience version:</span>
(on <span class="symbol">:E</span> <span class="symbol">:target-state</span>
  optional-executable-elements.<span class="keyword">..</span>)

<span class="comment">;; or if there is just a script and no target (just an event handler that stays in the same state):</span>
(handle <span class="symbol">:E</span> expr)
<span class="comment">;; means:</span>
(transition {<span class="symbol">:event</span> <span class="symbol">:E</span>}
  (script {<span class="symbol">:expr</span> expr}))</code></pre>
</div>
</div>
<div class="paragraph">
<p>A good use-case for a macro comes up when you want to emit nodes that might be better suited for a diagram tool.
The UML state chart system defines a choice node which is a node that makes a decision about where to transition to.
In the SCXML standard they are coded as a state that includes nothing but event-less transitions with conditions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">  (state {<span class="symbol">:id</span> node-id <span class="symbol">:diagram/prototype</span> <span class="symbol">:choice</span>}
    (transition {<span class="symbol">:cond</span> pred <span class="symbol">:target</span> target-state})
    (transition {<span class="symbol">:cond</span> pred2 <span class="symbol">:target</span> target-state2})
    (transition {<span class="symbol">:target</span> else-target-state})</code></pre>
</div>
</div>
<div class="paragraph">
<p>Which is not only a bit noisy, but it isn&#8217;t immediately obvious to the reader that this is a node that merely makes a choice.
Additionally, with the lambda execution model the predicates are code, so there is no way for them to easily be emitted to a diagram.</p>
</div>
<div class="paragraph">
<p>So there is a macro version of this called <code>choice</code> in the <code>convenience-macros</code> namespace:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">  (choice {<span class="symbol">:id</span> node-id <span class="keyword">..</span><span class="keyword">.</span>}
    pred  target-state
    pred2 target-state2
    <span class="symbol">:else</span> else-target-state)</code></pre>
</div>
</div>
<div class="paragraph">
<p>that is not only more concise, but adds <code>{:diagram/condition "pred"}</code>
to the transitions properties (the stringified expression of the predicate).</p>
</div>
<div class="paragraph">
<p>There is also a function version of <code>choice</code> in <code>convenience</code> that does no add the diagram note, but looks identical to the reader.</p>
</div>
<div class="paragraph">
<p>See the docstrings in those namespaces for more functions/macros that can make your charts more concise.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_custom_executable_content"><a class="anchor" href="#_custom_executable_content"></a><a class="link" href="#_custom_executable_content">6. Custom Executable Content</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The SCXML standard defines a number of elements it terms "Executable Content", meaning child nodes that do some action.
For example, <code>send</code> is executable content of this <code>on-entry</code> node:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(state {}
  (on-entry {}
     (<span class="keyword">send</span> <span class="keyword">..</span><span class="keyword">.</span>)))</code></pre>
</div>
</div>
<div class="paragraph">
<p>The standard allows for a compliant implementation to include extra executable content, but since this library is in Clojure you have the power of macros and functions, which XML does not.</p>
</div>
<div class="paragraph">
<p>The internals allow you to return a collection of elements from a function, which will be "spliced" in place.
This allows you to easily create macros and functions that can make your state charts much easier to write.
Some examples in the library source code are the com.fulcrologic.statecharts.convenience-macros/choice macro, and functions like <code>com.fulcrologic.statecharts.integration.fulcro.routing/rstate</code> in the Fulcro UI Routing support.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_integration_with_fulcro"><a class="anchor" href="#_integration_with_fulcro"></a><a class="link" href="#_integration_with_fulcro">7. Integration with Fulcro</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Fulcro integration for state charts has the following general enhancements over the standard state charts:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use the Fulcro app&#8217;s state database as the DataModel</p>
</li>
<li>
<p>Use core.async to automatically support an EventQueue</p>
</li>
<li>
<p>Support a "local data" area for the state chart session that won&#8217;t accidentally collide with other database concerns.</p>
</li>
<li>
<p>Allow for the use of actors (a component abstraction) and aliases (to database locations)</p>
</li>
<li>
<p>Supply an extensible set of operations that executable elements can leverage:</p>
<div class="ulist">
<ul>
<li>
<p>The ability to use Fulcro&#8217;s load to populate the state database.</p>
</li>
<li>
<p>The ability to invoke remote mutations.</p>
</li>
<li>
<p>The ability to leverage mutation helpers for optimistic updates.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Namespace aliases used in this document:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">[com.fulcrologic.fulcro.application <span class="symbol">:as</span> app]
[com.fulcrologic.fulcro.components <span class="symbol">:as</span> <span class="keyword">comp</span> <span class="symbol">:refer</span> [defsc]]
[com.fulcrologic.statecharts.elements <span class="symbol">:as</span> ele]
[com.fulcrologic.statecharts <span class="symbol">:as</span> sc]
[com.fulcrologic.statecharts.chart <span class="symbol">:as</span> chart]
[com.fulcrologic.statecharts.data-model.working-memory-data-model <span class="symbol">:as</span> wmdm]
[com.fulcrologic.statecharts.data-model.operations <span class="symbol">:as</span> ops]
[com.fulcrologic.statecharts.integration.fulcro <span class="symbol">:as</span> scf]
[com.fulcrologic.statecharts.integration.fulcro.operations <span class="symbol">:as</span> fop]
[com.fulcrologic.statecharts.integration.fulcro.async-operations <span class="symbol">:as</span> afop]
[com.fulcrologic.statecharts.protocols <span class="symbol">:as</span> sp]</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_basic_usage"><a class="anchor" href="#_basic_usage"></a><a class="link" href="#_basic_usage">7.1. Basic Usage</a></h3>
<div class="paragraph">
<p>There are three basic steps: install the support, register machines, and start them:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="comment">;; 1. Install state charts on the app. Should be done once at startup, but this is an idempotent operation.</span>
(scf/install-fulcro-statecharts! app)

<span class="comment">;; 2. Define your charts</span>
(<span class="keyword">def</span> <span class="function">chart</span> (chart/statechart {}
         <span class="keyword">..</span><span class="keyword">.</span>))

<span class="comment">;; 3. Register your chart under a well-known name. NOTE: The state charts have to be installed *before* calling register!</span>
(scf/register-statechart! app <span class="symbol">::chart</span> chart)

<span class="keyword">..</span><span class="keyword">.</span>

<span class="comment">;; 4. Start some state chart. The session-id can be a unique uuid, or a well known thing like a keyword. Be careful, though,</span>
<span class="comment">;; because starting a machine using an existing ID will overwrite the existing one.</span>
(scf/start! app {<span class="symbol">:machine</span> <span class="symbol">::chart</span>        <span class="comment">; registered chart name</span>
                 <span class="symbol">:session-id</span> <span class="symbol">:some-id</span>})  <span class="comment">; globally unique session id</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_data_model"><a class="anchor" href="#_the_data_model"></a><a class="link" href="#_the_data_model">7.2. The Data Model</a></h3>
<div class="paragraph">
<p>The Fulcro state charts data model has a number of features to help you work with Fulcro applications.</p>
</div>
<div class="paragraph">
<p>Two special concepts were take from Fulcro&#8217;s own UI state machines: aliases and actors.
These are implemented purely on the data model by simply adding entries to a state chart&#8217;s local data under the special keys:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>:fulcro/aliases</code> - A map from a keyword to a path.
The path itself can be any legal DataModel path (see later) except for another alias.</p>
</li>
<li>
<p><code>:fulcro/actors</code> - A map from a keyword to an <code>scf/actor</code>, which tracks the class and ident of a UI component.
Can be used to find the UI component (for normalization/loads) and in data paths.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Notes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Actors MUST be identified by keywords with an <code>actor</code> namespace: e.g. <code>:actor/thing</code>.</p>
</li>
<li>
<p>Actor keywords may only appear as the first element of a path.</p>
</li>
<li>
<p>Aliases are NOT used within paths.
They define a path.
Therefore, arguments that would normally take a vector to describe a data path will usually accept an alias keyword instead.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_initializing_the_data_model"><a class="anchor" href="#_initializing_the_data_model"></a><a class="link" href="#_initializing_the_data_model">7.2.1. Initializing the Data Model</a></h4>
<div class="paragraph">
<p>You can use the initial data in <code>sp/start!</code> or a top-level <code>data-model</code> element to put data into the local storage of your state chart.
This is particularly useful for specifying things like aliases on the chart itself, but defining actors at runtime:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">def</span> <span class="function">c</span> (chart/statechart {}
         (data-model {<span class="symbol">:expr</span> {<span class="symbol">:fulcro/aliases</span> {<span class="symbol">:a</span> [<span class="symbol">:actor/thing</span> <span class="symbol">:thing/field</span>]}}})
         <span class="keyword">..</span><span class="keyword">.</span>))
(scf/register-statechart! app <span class="symbol">::c</span> c)

<span class="keyword">..</span><span class="keyword">.</span>

(scf/start! app {<span class="symbol">:machine</span> <span class="symbol">::c</span>
                 <span class="symbol">:session-id</span> <span class="symbol">:some-id</span>
                 <span class="symbol">:data</span> {<span class="symbol">:fulcro/actors</span> {<span class="symbol">:actor/this</span> (scf/actor Thing [<span class="symbol">:thing/id</span> <span class="integer">1</span>])}}})</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above code defines a chart that will have <code>:fulcro/aliases</code> on the local data model because of the state chart definition, and will have a runtime value for the <code>:fulcro/actors</code> based on data that was passed during start.
Anything initialized this way will go into the local data store (which is a path based on the session id in the app database).</p>
</div>
<div class="paragraph">
<p>Changing aliases and actors on the fly is therefore a simple matter of doing an <code>op/assign</code> operation on the data model.</p>
</div>
</div>
<div class="sect3">
<h4 id="_data_locations"><a class="anchor" href="#_data_locations"></a><a class="link" href="#_data_locations">7.2.2. Data Locations</a></h4>
<div class="paragraph">
<p>There are four primary ways to address data in the data model, and the standard state chart operations such as <code>op/assign</code> already support these abstract paths:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">A keyword (not in a vector)</dt>
<dd>
<p>IF this keyword exists in the <code>:fulcro/aliases</code> map, then the value
of that alias (which can be a path that contains any of the other things in this list) is used to find the location; otherwise the keyword is relative in the root of the LOCAL data for the state chart.</p>
</dd>
<dt class="hdlist1">A vector starting with <code>:ROOT</code> (or a keyword that doesn&#8217;t match the other cases)</dt>
<dd>
<p>A path in the
local data of the state chart.
Same as using a path without <code>:ROOT</code>.
Included to be compatible with the standard location support.</p>
</dd>
<dt class="hdlist1">A vector starting with <code>:fulco/state</code> or <code>:fulcro/state-map</code></dt>
<dd>
<p>Indicates an absolute path in the
Fulcro app database.</p>
</dd>
<dt class="hdlist1">A vector starting with an actor name</dt>
<dd>
<p>If the first element of the vector matches an entry in the local state charts <code>:fulcro/actors</code> then <code>:fulcro/state</code> and the ident of that actor are spliced together in place of that keyword and the resulting path is treated as above.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_executable_content"><a class="anchor" href="#_executable_content"></a><a class="link" href="#_executable_content">7.3. Executable Content</a></h3>
<div class="paragraph">
<p>The executable content nodes (predicates and other expressions) in the state chart can be functions of two arguments: <code>env</code> (the processing environment) and <code>data</code>.</p>
</div>
<div class="paragraph">
<p>You can get the current state chart session ID using the processing environment, and you can also pull the various components of the state chart system from there (e.g. <code>(::sc/event-queue env)</code>).
The
<code>data</code> argument includes ALL the state chart local data (including the special <code>:fulcro/aliases</code>
and <code>:fulcro/actors</code>, which have special meaning but are really just normal local data).
The <code>data</code>
will also include the standard <code>:_event</code> (which is a map that has things like <code>:target</code>) and an extended key for <code>:fulcro/state-map</code> which has the current value of the Fulcro state database.</p>
</div>
<div class="sect3">
<h4 id="_operations"><a class="anchor" href="#_operations"></a><a class="link" href="#_operations">7.3.1. Operations</a></h4>
<div class="paragraph">
<p>Non-predicate executable content (e.g. <code>script</code>) functions can return a vector of operations to run.
The standard set (assign and delete) are supported, and use the extended path support described for the DataModel.</p>
</div>
<div class="paragraph">
<p>There are some additional operations for doing I/O:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>(fop/invoke-remote txn options)</code></dt>
<dd>
<p>Run a single-mutation txn (e.g. <code>[(f {:x 1})]</code>) on a remote.
The options allow you to specify events to trigger on the results.
See <code>scf/mutation-result</code>.
You can, of course use data <code>:target</code> and <code>:returning</code> to auto-merge graph data return values.
The <code>:target</code> option can use an actor keyword as a convenience. <code>:target</code> Can be a normal Fulcro state-map path, a defined alias, or a path that can include actors (which will splice the actor&#8217;s ident into the target path).</p>
</dd>
<dt class="hdlist1"><code>(fop/load query-root component-or-actor options)</code></dt>
<dd>
<p>Issue a Fulcro load with an EQL query. <code>options</code>
supposed the normal data fetch arguments, and additionally let&#8217;s you indicate what events to send when done/failed.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>When using <code>invoke-remote</code> you will often <strong>not</strong> have a local Fulcro CLJS mutation.
This means that you&#8217;d normally need to syntax-quote the transaction; however, remember that the Fulcro mutations namespace includes a
<code>declare-mutation</code> helper that will make a "callable" function-like object that just returns itself as data.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(m/declare-mutation login app.authentication.session/login)

<span class="keyword">..</span><span class="keyword">.</span>

(<span class="keyword">def</span> <span class="function">statechart</span>
<span class="keyword">..</span><span class="keyword">.</span>
   (script {<span class="symbol">:expr</span> [(fop/invoke-remote [(login {<span class="keyword">..</span><span class="keyword">.</span>})] {<span class="symbol">:ok-event</span> <span class="symbol">:event/success</span> <span class="symbol">:error-event</span> <span class="symbol">:event/failed</span>)]}))</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_async_operations"><a class="anchor" href="#_async_operations"></a><a class="link" href="#_async_operations">7.3.2. Async Operations</a></h4>
<div class="paragraph">
<p>When using the async execution engine (<code>:async? true</code>), you can issue Fulcro loads and remote mutations that resolve as promises within the algorithm.
The chart transitions atomically  it never observably rests in a "loading" state.</p>
</div>
<div class="paragraph">
<p>The point is to make async operations "park" (effectively block) the statechart execution until the promise is fulfilled or rejected. This
allows you to write statecharts that do not need so many intermediate states for tracking if a promise is fulfilled.</p>
</div>
<div class="paragraph">
<p>To enable async operations, pass <code>:async? true</code> when installing statecharts:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(scf/install-fulcro-statecharts! app {<span class="symbol">:async?</span> <span class="predefined-constant">true</span>})</code></pre>
</div>
</div>
<div class="paragraph">
<p>This swaps in the async processor and execution model from the <a href="#_async_execution_engine">Async Execution Engine</a> section.</p>
</div>
<div class="paragraph">
<p>The <code>com.fulcrologic.statecharts.integration.fulcro.async-operations</code> namespace (aliased as <code>afop</code>) provides two layers of async support.</p>
</div>
<div class="sect4">
<h5 id="_composable_operation_maps_recommended"><a class="anchor" href="#_composable_operation_maps_recommended"></a><a class="link" href="#_composable_operation_maps_recommended">Composable Operation Maps (Recommended)</a></h5>
<div class="paragraph">
<p><code>afop/load</code> and <code>afop/invoke-remote</code> return <strong>operation maps</strong> that can be mixed into the same result vector as synchronous operations like <code>ops/assign</code>.
The async execution engine detects these maps and awaits the underlying promise automatically:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="comment">;; Load data and set a flag  both in one expression result</span>
(state {<span class="symbol">:id</span> <span class="symbol">:loading-user</span>}
  (on-entry {}
    (script {<span class="symbol">:expr</span> (<span class="keyword">fn</span> [env data]
                     [(ops/assign <span class="symbol">:loading?</span> <span class="predefined-constant">true</span>)
                      (afop/load <span class="symbol">:user</span> User {<span class="symbol">::sc/ok-event</span>    <span class="symbol">:event/user-loaded</span>
                                             <span class="symbol">::sc/error-event</span> <span class="symbol">:event/load-failed</span>})])}))
  (transition {<span class="symbol">:event</span> <span class="symbol">:event/user-loaded</span> <span class="symbol">:target</span> <span class="symbol">:viewing-user</span>})
  (transition {<span class="symbol">:event</span> <span class="symbol">:event/load-failed</span> <span class="symbol">:target</span> <span class="symbol">:error</span>}))</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>afop/load</code> parameters:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>query-root</code>  A keyword or ident for the root of the remote query</p>
</li>
<li>
<p><code>component-or-actor</code>  A Fulcro component class, or a keyword naming a known actor</p>
</li>
<li>
<p><code>options</code>:</p>
<div class="ulist">
<ul>
<li>
<p><code>::sc/ok-event</code> / <code>::sc/error-event</code>  Events to raise on completion/failure</p>
</li>
<li>
<p><code>::sc/ok-data</code> / <code>::sc/error-data</code>  Extra data to merge into the event</p>
</li>
<li>
<p><code>::sc/target-alias</code>  Target the load result at a statechart alias</p>
</li>
<li>
<p>Other <code>df/load!</code> options (<code>:marker</code>, <code>:remote</code>, etc.)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>afop/invoke-remote</code> parameters:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>txn</code>  A Fulcro transaction vector containing a single mutation</p>
</li>
<li>
<p><code>options</code>:</p>
<div class="ulist">
<ul>
<li>
<p><code>:ok-event</code> / <code>:error-event</code>  Events to raise on success/failure</p>
</li>
<li>
<p><code>:ok-data</code> / <code>:error-data</code>  Extra data for the events</p>
</li>
<li>
<p><code>:target</code>  Data-targeting path (vector, alias keyword, or actor-prefixed path)</p>
</li>
<li>
<p><code>:returning</code>  Component class or actor keyword for normalization</p>
</li>
<li>
<p><code>:mutation-remote</code>  Remote name (defaults to <code>:remote</code>)</p>
</li>
<li>
<p><code>:tx-options</code>  Options passed to <code>rc/transact!</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="comment">;; Remote mutation with optimistic update</span>
(state {<span class="symbol">:id</span> <span class="symbol">:saving</span>}
  (on-entry {}
    (script {<span class="symbol">:expr</span> (<span class="keyword">fn</span> [env data]
                     [(ops/assign <span class="symbol">:saving?</span> <span class="predefined-constant">true</span>)
                      (afop/invoke-remote [(save-user (<span class="symbol">:form-data</span> data))]
                        {<span class="symbol">:ok-event</span>    <span class="symbol">:event/saved</span>
                         <span class="symbol">:error-event</span> <span class="symbol">:event/save-failed</span>
                         <span class="symbol">:returning</span>   User})])}))
  (transition {<span class="symbol">:event</span> <span class="symbol">:event/saved</span> <span class="symbol">:target</span> <span class="symbol">:success</span>})
  (transition {<span class="symbol">:event</span> <span class="symbol">:event/save-failed</span> <span class="symbol">:target</span> <span class="symbol">:error</span>}))</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_promise_helpers_advanced"><a class="anchor" href="#_promise_helpers_advanced"></a><a class="link" href="#_promise_helpers_advanced">Promise Helpers (Advanced)</a></h5>
<div class="paragraph">
<p>For complex custom expressions, <code>afop/await-load</code> and <code>afop/await-mutation</code> are imperative functions that return promesa promises directly.
These are used internally by the operation-map handlers above, but are also available when you need full control.</p>
</div>
<div class="paragraph">
<p>Importantly, the async execution engine is not limited to Fulcro I/O  <strong>any</strong> function that returns a promise works.
This makes it straightforward to integrate with the broader async JS ecosystem (fetch, IndexedDB, Web APIs, third-party SDKs) without needing extra intermediate states in your chart:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="comment">;; Using await-load for a Fulcro load</span>
(script {<span class="symbol">:expr</span> (<span class="keyword">fn</span> [env data]
                 (afop/await-load env <span class="symbol">:user</span> User
                   {<span class="symbol">::sc/ok-event</span>    <span class="symbol">:event/user-loaded</span>
                    <span class="symbol">::sc/error-event</span> <span class="symbol">:event/load-failed</span>}))})

<span class="comment">;; Using a plain promise for a fetch call</span>
(script {<span class="symbol">:expr</span> (<span class="keyword">fn</span> [env data]
                 (p/let [response (js/fetch <span class="string"><span class="delimiter">&quot;</span><span class="content">/api/data</span><span class="delimiter">&quot;</span></span>)
                         json     (<span class="keyword">.</span>json response)]
                   [(ops/assign <span class="symbol">:result</span> (js-&gt;clj json <span class="symbol">:keywordize-keys</span> <span class="predefined-constant">true</span>))]))})</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>await-load</code> and <code>await-mutation</code> accept the same parameters as the operation-map constructors, plus an <code>env</code> argument (the statechart environment) as the first parameter.</p>
</div>
</div>
<div class="sect4">
<h5 id="_comparison_send_based_vs_async"><a class="anchor" href="#_comparison_send_based_vs_async"></a><a class="link" href="#_comparison_send_based_vs_async">Comparison: Send-based vs Async</a></h5>
<div class="paragraph">
<p>With standard operations (<code>fop/load</code>), intermediate states are visible:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="comment">;; Using fop/load  chart rests in :loading until external event arrives</span>
(state {<span class="symbol">:id</span> <span class="symbol">:loading</span>}
  (on-entry {}
    (script {<span class="symbol">:expr</span> (<span class="keyword">fn</span> [env data]
                     [(fop/load <span class="symbol">:user</span> User {<span class="symbol">::sc/ok-event</span> <span class="symbol">:event/loaded</span>})])}))
  (transition {<span class="symbol">:event</span> <span class="symbol">:event/loaded</span> <span class="symbol">:target</span> <span class="symbol">:viewing</span>}))</code></pre>
</div>
</div>
<div class="paragraph">
<p>With async operations (<code>afop/load</code>), the transition is atomic:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="comment">;; Using afop/load  atomic transition, never observably in :loading</span>
(state {<span class="symbol">:id</span> <span class="symbol">:loading</span>}
  (on-entry {}
    (script {<span class="symbol">:expr</span> (<span class="keyword">fn</span> [env data]
                     [(afop/load <span class="symbol">:user</span> User {<span class="symbol">::sc/ok-event</span> <span class="symbol">:event/loaded</span>})])}))
  (transition {<span class="symbol">:event</span> <span class="symbol">:event/loaded</span> <span class="symbol">:target</span> <span class="symbol">:viewing</span>}))</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The existing <code>fop/load</code> and <code>fop/invoke-remote</code> operations remain unchanged and continue to work with both sync and async execution engines.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_useful_helpers"><a class="anchor" href="#_useful_helpers"></a><a class="link" href="#_useful_helpers">7.4. Useful Helpers</a></h3>
<div class="sect3">
<h4 id="_functions"><a class="anchor" href="#_functions"></a><a class="link" href="#_functions">7.4.1. Functions</a></h4>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>(scf/local-data-path session-id)</code></dt>
<dd>
<p>Get the path of the local data for a given session.
This
is useful for adding a lookup ref to a UI component whose rendering depends on changes to this local state.</p>
</dd>
<dt class="hdlist1"><code>(scf/statechart-session-ident session-id)</code></dt>
<dd>
<p>Get the ident of the state chart session itself.
This
is useful for adding a lookup ref to a UI component whose rendering depends on changes to the state chart&#8217;s configuration.</p>
</dd>
<dt class="hdlist1"><code>(resolve-aliases data)</code></dt>
<dd>
<p>Used in executable content to return a map for all aliases.
It looks up every
alias from <code>:fulcro/aliases</code> and returns a map with them as keys, and their extracted data as values.</p>
</dd>
<dt class="hdlist1"><code>(resolve-actors data :actor/thing :actor/other &#8230;&#8203;)</code></dt>
<dd>
<p>Resolves the UI props of multiple named actors.
The
return value is a map from actor name to the UI props (tree).</p>
</dd>
<dt class="hdlist1"><code>(resolve-actors data :actor/thing)</code></dt>
<dd>
<p>Resolves the UI props of a single actor, and returns them.</p>
</dd>
<dt class="hdlist1"><code>(resolve-actor-class data actor-key)</code></dt>
<dd>
<p>Returns the Fulcro component that is currently acting as the UI
counterpart of the named actor, if known.</p>
</dd>
<dt class="hdlist1"><code>(scf/send! app-ish session-id event optional-data)</code></dt>
<dd>
<p>Send an event to a running state chart.</p>
</dd>
<dt class="hdlist1"><code>(scf/current-configuration app-ish session-id)</code></dt>
<dd>
<p>Returns the current configuration (active states) of the given
state chart instance.
Useful in the UI when you need to render content based on state, but remember to add
<code>(scf/statechart-session-ident session-id)</code> to any component query where that is necessary (to ensure render updates).</p>
</dd>
<dt class="hdlist1"><code>(scf/mutation-result data)</code></dt>
<dd>
<p>Extracts the raw return value of a remote mutation when the event being processed
is the result of a mutation result that was originally triggered by a <code>fops/invoke-remote</code>.</p>
</dd>
<dt class="hdlist1"><code>(m/declare-mutation)</code></dt>
<dd>
<p>Makes a function-like object that can be used to generate remote mutation calls in transactions for <code>invoke-remote</code>.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_content_of_data_in_executable_content"><a class="anchor" href="#_content_of_data_in_executable_content"></a><a class="link" href="#_content_of_data_in_executable_content">7.4.2. Content of <code>data</code> in Executable Content</a></h4>
<div class="paragraph">
<p>The <code>data</code> parameter of runtime content (e.g. script nodes) contains:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The local data of the state chart (at the top level).</p>
</li>
<li>
<p>The special standard (from SCXML) <code>:_event</code> that is the event that is being processed, which in turn has:</p>
<div class="ulist">
<ul>
<li>
<p><code>:data</code> that contains any data sent <strong>with</strong> the event.</p>
</li>
<li>
<p><code>:target</code> The session ID of the state chart</p>
</li>
</ul>
</div>
</li>
<li>
<p>A special <code>:fulcro/state-map</code> key that is the current <strong>value</strong> of the Fulcro application state.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_runtime_env_of_executable_content"><a class="anchor" href="#_runtime_env_of_executable_content"></a><a class="link" href="#_runtime_env_of_executable_content">7.4.3. Runtime <code>env</code> of Executable Content</a></h4>
<div class="paragraph">
<p>The runtime <code>env</code> in executable elements includes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Any data passed via the <code>extra-env</code> argument to <code>install-fulcro-statecharts!</code></p>
</li>
<li>
<p><code>:fulcro/app</code>                - The Fucro app itself.</p>
</li>
<li>
<p><code>::sc/statechart-registry</code>   - The state chart Registry instance</p>
</li>
<li>
<p><code>::sc/data-model</code>            - The state chart DataModel instance</p>
</li>
<li>
<p><code>::sc/event-queue</code>           - The state chart EventQueue instance</p>
</li>
<li>
<p><code>::sc/working-memory-store</code>  - The state chart working memory store</p>
</li>
<li>
<p><code>::sc/processor</code>             - The state chart processing algorithm</p>
</li>
<li>
<p><code>::sc/invocation-processors</code> - The supported invocation processors</p>
</li>
<li>
<p><code>::sc/execution-model</code>       - The CLJC state chart ExecutionModel</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_react_hooks"><a class="anchor" href="#_react_hooks"></a><a class="link" href="#_react_hooks">7.5. React Hooks</a></h3>
<div class="paragraph">
<p>There is support for using a state chart as a co-located element of a hooks-based component.</p>
</div>
<div class="paragraph">
<p>The basic idea is that the state chart will be started when the component uses it, and when the component leaves the screen the chart is sent an <code>:event/unmounted</code>.
If the chart reaches a top-level final state, then it will be GC&#8217;d from state.</p>
</div>
<div class="paragraph">
<p>The session ID of the chart is auto-assigned a random UUID, but you can specify a known session ID to allow for a state chart to survive the component mount/unmount cycle.</p>
</div>
<div class="paragraph">
<p>Here is an example of using this support to create a simple traffic light that can regulate (red/yellow/green) or blink red:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defsc TrafficLight [this {<span class="symbol">:ui/keys</span> [color]}]
  {<span class="symbol">:query</span>         [<span class="symbol">:ui/color</span>]
   <span class="symbol">:initial-state</span> {<span class="symbol">:ui/color</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">green</span><span class="delimiter">&quot;</span></span>}
   <span class="symbol">:ident</span>         (<span class="keyword">fn</span> [] [<span class="symbol">:component/id</span> <span class="symbol">::TrafficLight</span>])
   <span class="symbol">:statechart</span>    (statechart {}
                    (state {<span class="symbol">:id</span> <span class="symbol">:state/running</span>}
                      (on <span class="symbol">:event/unmount</span> <span class="symbol">:state/exit</span>)
                      (transition {<span class="symbol">:event</span> <span class="symbol">:event/toggle</span>}
                        (script {<span class="symbol">:expr</span> (<span class="keyword">fn</span> [_ {<span class="symbol">:keys</span> [blink-mode?]}]
                                         [(ops/assign <span class="symbol">:blink-mode?</span> (<span class="keyword">not</span> blink-mode?))])}))

                      (state {<span class="symbol">:id</span> <span class="symbol">:state/green</span>}
                        (on-entry {} (script {<span class="symbol">:expr</span> (<span class="keyword">fn</span> [_ _] [(fops/assoc-alias <span class="symbol">:color</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">green</span><span class="delimiter">&quot;</span></span>)])}))
                        (send-after {<span class="symbol">:delay</span> <span class="integer">2000</span>
                                     <span class="symbol">:id</span>    <span class="symbol">:gty</span>
                                     <span class="symbol">:event</span> <span class="symbol">:timeout</span>})
                        (transition {<span class="symbol">:event</span>  <span class="symbol">:timeout</span>
                                     <span class="symbol">:target</span> <span class="symbol">:state/yellow</span>}))
                      (state {<span class="symbol">:id</span> <span class="symbol">:state/yellow</span>}
                        (on-entry {} (script {<span class="symbol">:expr</span> (<span class="keyword">fn</span> [_ _] [(fops/assoc-alias <span class="symbol">:color</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">yellow</span><span class="delimiter">&quot;</span></span>)])}))
                        (send-after {<span class="symbol">:delay</span> <span class="integer">500</span>
                                     <span class="symbol">:id</span>    <span class="symbol">:ytr</span>
                                     <span class="symbol">:event</span> <span class="symbol">:timeout</span>})
                        (transition {<span class="symbol">:event</span>  <span class="symbol">:timeout</span>
                                     <span class="symbol">:target</span> <span class="symbol">:state/red</span>}))
                      (state {<span class="symbol">:id</span> <span class="symbol">:state/red</span>}
                        (on-entry {} (script {<span class="symbol">:expr</span> (<span class="keyword">fn</span> [_ _] [(fops/assoc-alias <span class="symbol">:color</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">red</span><span class="delimiter">&quot;</span></span>)])}))
                        (send-after {<span class="symbol">:delay</span> <span class="integer">2000</span>
                                     <span class="symbol">:id</span>    <span class="symbol">:rtg</span>
                                     <span class="symbol">:event</span> <span class="symbol">:timeout</span>})
                        (transition {<span class="symbol">:cond</span>   (<span class="keyword">fn</span> [_ {<span class="symbol">:keys</span> [blink-mode?]}]
                                               (<span class="keyword">boolean</span> blink-mode?))
                                     <span class="symbol">:event</span>  <span class="symbol">:timeout</span>
                                     <span class="symbol">:target</span> <span class="symbol">:state/black</span>})
                        (transition {<span class="symbol">:event</span>  <span class="symbol">:timeout</span>
                                     <span class="symbol">:target</span> <span class="symbol">:state/green</span>}))
                      (state {<span class="symbol">:id</span> <span class="symbol">:state/black</span>}
                        (on-entry {} (script {<span class="symbol">:expr</span> (<span class="keyword">fn</span> [_ _] [(fops/assoc-alias <span class="symbol">:color</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">black</span><span class="delimiter">&quot;</span></span>)])}))
                        (send-after {<span class="symbol">:delay</span> <span class="integer">500</span>
                                     <span class="symbol">:id</span>    <span class="symbol">:otr</span>
                                     <span class="symbol">:event</span> <span class="symbol">:timeout</span>})
                        (transition {<span class="symbol">:event</span>  <span class="symbol">:timeout</span>
                                     <span class="symbol">:target</span> <span class="symbol">:state/red</span>})))
                    (final {<span class="symbol">:id</span> <span class="symbol">:state/exit</span>}))
   <span class="symbol">:use-hooks?</span>    <span class="predefined-constant">true</span>}
  (<span class="keyword">let</span> [{<span class="symbol">:keys</span> [send! local-data]} (sch/use-statechart this {<span class="symbol">:data</span> {<span class="symbol">:fulcro/aliases</span> {<span class="symbol">:color</span> [<span class="symbol">:actor/component</span> <span class="symbol">:ui/color</span>]}}})]
    (dom/div {}
      (dom/div {<span class="symbol">:style</span> {<span class="symbol">:backgroundColor</span> color
                        <span class="symbol">:width</span>           <span class="string"><span class="delimiter">&quot;</span><span class="content">20px</span><span class="delimiter">&quot;</span></span>
                        <span class="symbol">:height</span>          <span class="string"><span class="delimiter">&quot;</span><span class="content">20px</span><span class="delimiter">&quot;</span></span>}})
      (dom/button {<span class="symbol">:onClick</span> (<span class="keyword">fn</span> [] (send! <span class="symbol">:event/toggle</span>))}
        (<span class="keyword">if</span> (<span class="symbol">:blink-mode?</span> local-data) <span class="string"><span class="delimiter">&quot;</span><span class="content">Blink</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Regulate</span><span class="delimiter">&quot;</span></span>)))))</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_hierarchical_routing"><a class="anchor" href="#_hierarchical_routing"></a><a class="link" href="#_hierarchical_routing">7.6. Hierarchical Routing</a></h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The legacy <code>com.fulcrologic.statecharts.integration.fulcro.ui-routes</code> namespace is
deprecated. All examples below use the new <code>routing</code> namespace. The old namespace
remains available for backward compatibility but does not include URL sync, cross-chart
routing, or configuration validation.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_why_statechart_driven_routing"><a class="anchor" href="#_why_statechart_driven_routing"></a><a class="link" href="#_why_statechart_driven_routing">7.6.1. Why Statechart-Driven Routing?</a></h4>
<div class="paragraph">
<p>Routing in a web application is fundamentally a state machine problem.
You have a set of possible screens, transitions between them, guards that prevent certain transitions, and side effects (loading data) that must occur when entering a screen.
Traditional routing libraries model this implicitly with callback chains, middleware stacks, and ad-hoc guard logic.
Statecharts make it explicit.</p>
</div>
<div class="paragraph">
<p>With statechart-driven routing you get:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Guards and denial are first-class.</strong>
A dirty form blocking navigation is not a bolt-on: it is a guard condition on the transition.
The statechart naturally holds the "denied" state and lets you offer "Continue anyway?" or "Cancel" without juggling flags.</p>
</li>
<li>
<p><strong>Async side effects on entry.</strong>
When a user navigates to a project detail page, the statechart&#8217;s <code>on-entry</code> handler can fire a data load.
Because this library supports async processing (see <a href="#Asynchronous Processing">[Asynchronous Processing]</a>), the load completes before the next event is processed.
This eliminates the class of complexity where you have to model async tracking with states/transitions.</p>
</li>
<li>
<p><strong>Composable child charts.</strong>
An module of the app can be a self-contained statechart invoked by the parent routing chart.
The module&#8217;s chart manages its own sub-routes, its own guards, and its own data loads&#8201;&#8212;&#8201;yet the parent chart sees it as a single state.
This enables code splitting, module boundaries, and isolated testing.</p>
</li>
<li>
<p><strong>Bidirectional URL sync.</strong>
The URL is derived from the statechart configuration&#8201;&#8212;&#8201;not the other way around.
Browser back/forward triggers a statechart event that goes through the same guard and transition logic as programmatic navigation.</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
Routing works best with async statechart processing. When calling <code>install-fulcro-statecharts!</code>, pass <code>:async? true</code> so that on-entry handlers (which often trigger data loads) complete before the next event is processed. The demo code in this section assumes async mode.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_end_to_end_setup_walkthrough"><a class="anchor" href="#_end_to_end_setup_walkthrough"></a><a class="link" href="#_end_to_end_setup_walkthrough">7.6.2. End-to-End Setup Walkthrough</a></h4>
<div class="paragraph">
<p>This section walks through every step to get routing working, from zero to a running application.
The code mirrors the <code>routing-demo2</code> example included in the source tree.</p>
</div>
<div class="sect4">
<h5 id="_step_1_create_the_fulcro_application"><a class="anchor" href="#_step_1_create_the_fulcro_application"></a><a class="link" href="#_step_1_create_the_fulcro_application">Step 1: Create the Fulcro Application</a></h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">app.main</span>
  (<span class="symbol">:require</span>
    [com.fulcrologic.fulcro.application <span class="symbol">:as</span> app]
    <span class="comment">;; These requires pull in the async implementations -- needed for :async? true</span>
    [com.fulcrologic.statecharts.algorithms.v20150901-async]
    [com.fulcrologic.statecharts.event-queue.async-event-loop]
    [com.fulcrologic.statecharts.execution-model.lambda-async]
    [com.fulcrologic.statecharts.integration.fulcro <span class="symbol">:as</span> scf]
    [com.fulcrologic.statecharts.integration.fulcro.routing <span class="symbol">:as</span> sroute]
    <span class="comment">;; Pull in browser history implementation (CLJS dead-code elimination safe)</span>
    [com.fulcrologic.statecharts.integration.fulcro.routing.browser-history]))

(<span class="keyword">defonce</span> <span class="function">app-instance</span>
  (app/fulcro-app
    {<span class="symbol">:remotes</span> {<span class="symbol">:remote</span> (my-remote)}}))</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_step_2_install_statechart_infrastructure"><a class="anchor" href="#_step_2_install_statechart_infrastructure"></a><a class="link" href="#_step_2_install_statechart_infrastructure">Step 2: Install Statechart Infrastructure</a></h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(scf/install-fulcro-statecharts! app-instance
  {<span class="symbol">:async?</span>      <span class="predefined-constant">true</span>
   <span class="symbol">:event-loop?</span> <span class="predefined-constant">true</span>
   <span class="symbol">:on-save</span>     (<span class="keyword">fn</span> [session-id wmem]
                  <span class="comment">;; Required: drives state-to-URL synchronization</span>
                  (sroute/url-sync-on-save session-id wmem app-instance))})</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>:on-save</code> callback fires every time a statechart session&#8217;s working memory is persisted.
Calling <code>sroute/url-sync-on-save</code> inside it is what makes state-to-URL synchronization work.
Passing <code>app-instance</code> as the third argument enables child chart URL tracking&#8201;&#8212;&#8201;when a child chart transitions, the URL updates to reflect the full nested path.</p>
</div>
</div>
<div class="sect4">
<h5 id="_step_3_define_and_start_the_routing_chart"><a class="anchor" href="#_step_3_define_and_start_the_routing_chart"></a><a class="link" href="#_step_3_define_and_start_the_routing_chart">Step 3: Define and Start the Routing Chart</a></h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(sroute/start! app-instance my-routing-chart)</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>start!</code> registers the chart under <code>sroute/session-id</code> and starts a session.
No manual session ID or registration key management is needed.</p>
</div>
</div>
<div class="sect4">
<h5 id="_step_4_install_url_synchronization"><a class="anchor" href="#_step_4_install_url_synchronization"></a><a class="link" href="#_step_4_install_url_synchronization">Step 4: Install URL Synchronization</a></h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="comment">;; Store cleanup fn so shadow-cljs hot reload does not leak popstate listeners</span>
(<span class="keyword">defonce</span> <span class="function">url-sync-cleanup</span> (<span class="keyword">atom</span> <span class="predefined-constant">nil</span>))

<span class="comment">;; In your init function:</span>
(<span class="keyword">when-let</span> [old-cleanup @url-sync-cleanup] (old-cleanup))
(<span class="keyword">reset!</span> url-sync-cleanup
  (sroute/install-url-sync! app-instance))</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>install-url-sync!</code> must be called <strong>after</strong> <code>start!</code>.
It returns a cleanup function that removes all listeners&#8201;&#8212;&#8201;the <code>defonce</code> + <code>atom</code> pattern above ensures hot reloads do not accumulate stale popstate handlers.</p>
</div>
<div class="paragraph">
<p>On CLJS, a <code>BrowserURLHistory</code> provider is used by default.
On CLJ, you must pass a <code>:provider</code> explicitly (see <a href="#HeadlessTesting">Headless Testing</a>).</p>
</div>
</div>
<div class="sect4">
<h5 id="_step_5_mount_the_ui"><a class="anchor" href="#_step_5_mount_the_ui"></a><a class="link" href="#_step_5_mount_the_ui">Step 5: Mount the UI</a></h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(app/set-root! app-instance ui/Root {<span class="symbol">:initialize-state?</span> <span class="predefined-constant">true</span>})
(app/mount! app-instance ui/Root <span class="string"><span class="delimiter">&quot;</span><span class="content">app</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_complete_init_function"><a class="anchor" href="#_complete_init_function"></a><a class="link" href="#_complete_init_function">Complete init Function</a></h5>
<div class="paragraph">
<p>Here is the full initialization sequence (simplified from <code>routing-demo2/app.cljs</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">defn</span> ^<span class="symbol">:export</span> init []
  (app/set-root! app-instance ui/Root {<span class="symbol">:initialize-state?</span> <span class="predefined-constant">true</span>})
  (scf/install-fulcro-statecharts! app-instance
    {<span class="symbol">:async?</span>      <span class="predefined-constant">true</span>
     <span class="symbol">:event-loop?</span> <span class="predefined-constant">true</span>
     <span class="symbol">:on-save</span>     (<span class="keyword">fn</span> [sid wmem]
                    (sroute/url-sync-on-save sid wmem app-instance))})
  <span class="comment">;; Register any child charts that istates reference by ID</span>
  (scf/register-statechart! app-instance <span class="symbol">:app/admin-chart</span> admin-chart/admin-chart)
  <span class="comment">;; Start main routing chart</span>
  (sroute/start! app-instance chart/routing-chart)
  <span class="comment">;; Install URL sync (after start!)</span>
  (<span class="keyword">when-let</span> [old-cleanup @url-sync-cleanup] (old-cleanup))
  (<span class="keyword">reset!</span> url-sync-cleanup (sroute/install-url-sync! app-instance))
  (app/mount! app-instance ui/Root <span class="string"><span class="delimiter">&quot;</span><span class="content">app</span><span class="delimiter">&quot;</span></span>))

(<span class="keyword">defn</span> ^<span class="symbol">:export</span> refresh []
  (app/force-root-render! app-instance))</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="DefiningRoutes"><a class="anchor" href="#DefiningRoutes"></a><a class="link" href="#DefiningRoutes">7.6.3. Defining Routes</a></h4>
<div class="paragraph">
<p>A routing chart is built from four DSL functions: <code>routing-regions</code>, <code>routes</code>, <code>rstate</code>, and <code>istate</code>.</p>
</div>
<div class="sect4">
<h5 id="_routing_regions"><a class="anchor" href="#_routing_regions"></a><a class="link" href="#_routing_regions">routing-regions</a></h5>
<div class="paragraph">
<p><code>routing-regions</code> wraps a <code>routes</code> node in a parallel state that includes a small internal state machine for route denial (the "routing info" region).
This is what enables the denial modal pattern (see <a href="#BusyGuards">Busy Guards</a>).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(sroute/routing-regions
  (sroute/routes {<span class="keyword">..</span><span class="keyword">.</span>}
    <span class="keyword">..</span><span class="keyword">.</span>route states.<span class="keyword">..</span>))</code></pre>
</div>
</div>
<div class="paragraph">
<p>The result is a state node <code>:state/route-root</code> containing a parallel node with two regions: the routing info state machine and your routes.</p>
</div>
</div>
<div class="sect4">
<h5 id="_routes"><a class="anchor" href="#_routes"></a><a class="link" href="#_routes">routes</a></h5>
<div class="paragraph">
<p><code>routes</code> is the container for all route states within a routing region.
It generates transitions for every descendant <code>:route/target</code> and for every cross-chart target declared via <code>:route/reachable</code> on <code>istate</code> children.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(sroute/routes {<span class="symbol">:id</span> <span class="symbol">:region/main</span> <span class="symbol">:routing/root</span> `ui/RoutingRoot}
  (sroute/rstate {<span class="symbol">:route/target</span> `ui/Dashboard})
  (sroute/rstate {<span class="symbol">:route/target</span> `ui/ProjectList <span class="symbol">:route/segment</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">projects</span><span class="delimiter">&quot;</span></span>})
  (sroute/rstate {<span class="symbol">:route/target</span> `ui/ProjectDetail <span class="symbol">:route/params</span> #{<span class="symbol">:project-id</span>}}))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Required options:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>:id</code></dt>
<dd>
<p>The state ID for this routes node.</p>
</dd>
<dt class="hdlist1"><code>:routing/root</code></dt>
<dd>
<p>The Fulcro component that serves as the rendering parent for these routes. Must have a constant ident (e.g. <code>[:component/id ::RoutingRoot]</code>) or be the app root (no ident).</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Optional:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>:initial</code></dt>
<dd>
<p>The state ID of the initial route (defaults to first child).</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="_rstate"><a class="anchor" href="#_rstate"></a><a class="link" href="#_rstate">rstate</a></h5>
<div class="paragraph">
<p><code>rstate</code> creates a route state node.
When the statechart enters this state, three things happen automatically:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Route parameters</strong> from the event data are stored in the data model at <code>[:routing/parameters &lt;state-id&gt;]</code>.</p>
</li>
<li>
<p><strong>The target component is initialized</strong> in Fulcro&#8217;s state database (controlled by <code>sfro/initialize</code>).</p>
</li>
<li>
<p><strong>The parent component&#8217;s query is rewritten</strong> to include a join to the target, so the correct component renders.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(sroute/rstate {<span class="symbol">:route/target</span> `ui/ProjectDetail
                <span class="symbol">:route/segment</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">detail</span><span class="delimiter">&quot;</span></span>
                <span class="symbol">:route/params</span> #{<span class="symbol">:project-id</span>}})</code></pre>
</div>
</div>
<div class="paragraph">
<p>Options:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>:route/target</code></dt>
<dd>
<p>(Required) A component class or anything accepted by <code>comp/registry-key&#8594;class</code>. The state ID is automatically derived from this&#8201;&#8212;&#8201;do not pass an explicit <code>:id</code>.</p>
</dd>
<dt class="hdlist1"><code>:route/segment</code></dt>
<dd>
<p>(Optional) Custom URL path segment string. When absent, defaults to the simple name of the target (e.g. <code>ProjectDetail</code>). Used by the default URLCodec, which is customizable.</p>
</dd>
<dt class="hdlist1"><code>:route/params</code></dt>
<dd>
<p>(Optional) A set of keywords. When present in the routing event data, these keys are extracted and stored at <code>[:routing/parameters &lt;state-id&gt;]</code> in the data model.</p>
</dd>
<dt class="hdlist1"><code>:parallel?</code></dt>
<dd>
<p>(Optional) When true, this node is a parallel state.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>You can nest <code>rstate</code> nodes to create hierarchical routes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(sroute/routes {<span class="symbol">:routing/root</span> `ui/Root <span class="symbol">:id</span> <span class="symbol">:routes</span>}
  (sroute/rstate {<span class="symbol">:route/target</span> `ui/UserList <span class="symbol">:route/segment</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">users</span><span class="delimiter">&quot;</span></span>}
    (sroute/rstate {<span class="symbol">:route/target</span> `ui/UserDetail}
      (sroute/rstate {<span class="symbol">:route/target</span> `ui/UserEdit <span class="symbol">:route/segment</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">edit</span><span class="delimiter">&quot;</span></span>}))))</code></pre>
</div>
</div>
<div class="paragraph">
<p>The full URL for <code>UserEdit</code> composes as <code>/users/UserDetail/edit</code>&#8201;&#8212;&#8201;each ancestor&#8217;s segment is prepended.</p>
</div>
</div>
<div class="sect4">
<h5 id="_segment_composition"><a class="anchor" href="#_segment_composition"></a><a class="link" href="#_segment_composition">Segment Composition</a></h5>
<div class="paragraph">
<p>Each route state contributes one URL path segment.
By default the segment is the simple name of its <code>:route/target</code>.
Use <code>:route/segment</code> to override with a human-friendly string.</p>
</div>
<div class="paragraph">
<p>Segments compose from the routing root down to the active leaf:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 40%;">
<col style="width: 60%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Route Target</th>
<th class="tableblock halign-left valign-top">URL</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Dashboard</code> (no custom segment)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/Dashboard</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ProjectList</code> with <code>:route/segment "projects"</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/projects</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ProjectDetail</code> nested under <code>ProjectList</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/projects/ProjectDetail</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>UserEdit</code> with <code>:route/segment "edit"</code> nested under <code>UserDetail</code> nested under <code>UserList</code> with <code>:route/segment "users"</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/users/UserDetail/edit</code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="_route_parameters"><a class="anchor" href="#_route_parameters"></a><a class="link" href="#_route_parameters">Route Parameters</a></h5>
<div class="paragraph">
<p>In the default URL encoding route parameters are <strong>not</strong> encoded in URL path segments.
Instead they travel through event data and are persisted to the URL via a single opaque <code>_p</code> query parameter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="comment">;; Navigating with params:</span>
(sroute/route-to! app ProjectDetail {<span class="symbol">:project-id</span> <span class="integer">42</span>})
<span class="comment">;; URL: /projects/ProjectDetail?_p=&lt;base64-encoded-transit&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To declare which keys should be extracted from event data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(sroute/rstate {<span class="symbol">:route/target</span> `ui/ProjectDetail <span class="symbol">:route/params</span> #{<span class="symbol">:project-id</span>}})</code></pre>
</div>
</div>
<div class="paragraph">
<p>Parameters are then available in the data model at <code>[:routing/parameters &lt;state-id&gt;]</code>, where <code>&lt;state-id&gt;</code> is the keyword derived from the <code>:route/target</code>.</p>
</div>
<div class="paragraph">
<p>You can install an alternate <code>URLCodec</code> to customize this behavior.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="ComponentSetup"><a class="anchor" href="#ComponentSetup"></a><a class="link" href="#ComponentSetup">7.6.4. Component Setup Requirements</a></h4>
<div class="paragraph">
<p>Route target components must follow certain conventions for the routing system to manage their state and rendering correctly.</p>
</div>
<div class="sect4">
<h5 id="_constant_ident"><a class="anchor" href="#_constant_ident"></a><a class="link" href="#_constant_ident">Constant Ident</a></h5>
<div class="paragraph">
<p>Every route target must have an ident.
For singleton screens (dashboards, settings pages), use a constant ident:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defsc Dashboard [this {<span class="symbol">:dashboard/keys</span> [greeting]}]
  {<span class="symbol">:query</span>         [<span class="symbol">:dashboard/greeting</span>]
   <span class="symbol">:ident</span>         (<span class="keyword">fn</span> [] [<span class="symbol">:component/id</span> <span class="symbol">::Dashboard</span>])
   <span class="symbol">:initial-state</span> {<span class="symbol">:dashboard/greeting</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Welcome!</span><span class="delimiter">&quot;</span></span>}})</code></pre>
</div>
</div>
<div class="paragraph">
<p>For entity-based screens (project detail, user profile), use a data-driven ident:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defsc ProjectDetail [this {<span class="symbol">:project/keys</span> [id <span class="keyword">name</span> description]}]
  {<span class="symbol">:query</span> [<span class="symbol">:project/id</span> <span class="symbol">:project/name</span> <span class="symbol">:project/description</span>]
   <span class="symbol">:ident</span> <span class="symbol">:project/id</span>})</code></pre>
</div>
</div>
<div class="paragraph">
<p>When using a data-driven ident, you will typically need <code>sfro/initial-props</code> to provide the ident key from event data (see <a href="#ComponentOptions">Component Options Reference</a>).</p>
</div>
</div>
<div class="sect4">
<h5 id="_preserve_dynamic_query"><a class="anchor" href="#_preserve_dynamic_query"></a><a class="link" href="#_preserve_dynamic_query">preserve-dynamic-query?</a></h5>
<div class="paragraph">
<p>The routing system dynamically rewrites parent component queries to include a join to the active route target.
Fulcro hot code reload resets queries to their original values&#8201;&#8212;&#8201;which would break active routes.
To prevent this, <strong>every component that renders a subroute must set</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defsc RoutingRoot [this {<span class="symbol">:ui/keys</span> [current-route]}]
  {<span class="symbol">:query</span>                   [<span class="symbol">:ui/current-route</span>]
   <span class="symbol">:ident</span>                   (<span class="keyword">fn</span> [] [<span class="symbol">:component/id</span> <span class="symbol">::RoutingRoot</span>])
   <span class="symbol">:preserve-dynamic-query?</span> <span class="predefined-constant">true</span>   <span class="comment">;; REQUIRED</span>
   <span class="symbol">:initial-state</span>           {<span class="symbol">:ui/current-route</span> {}}})</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_rendering_subroutes"><a class="anchor" href="#_rendering_subroutes"></a><a class="link" href="#_rendering_subroutes">Rendering Subroutes</a></h5>
<div class="paragraph">
<p>Use <code>sroute/ui-current-subroute</code> to render the active child in a standard (non-parallel) routing region:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defsc RoutingRoot [this {<span class="symbol">:ui/keys</span> [current-route]}]
  {<span class="symbol">:query</span>                   [<span class="symbol">:ui/current-route</span>]
   <span class="symbol">:ident</span>                   (<span class="keyword">fn</span> [] [<span class="symbol">:component/id</span> <span class="symbol">::RoutingRoot</span>])
   <span class="symbol">:preserve-dynamic-query?</span> <span class="predefined-constant">true</span>
   <span class="symbol">:initial-state</span>           {<span class="symbol">:ui/current-route</span> {}}}
  (dom/div {}
    (sroute/ui-current-subroute this comp/factory)))</code></pre>
</div>
</div>
<div class="paragraph">
<p>For parallel routing regions, use <code>sroute/ui-parallel-route</code> with the target&#8217;s registry key:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(sroute/ui-parallel-route this <span class="symbol">::SomeTarget</span> comp/factory)</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_navigation"><a class="anchor" href="#_navigation"></a><a class="link" href="#_navigation">Navigation</a></h5>
<div class="paragraph">
<p>Navigate programmatically using <code>route-to!</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="comment">;; From a component's event handler:</span>
(sroute/route-to! this <span class="symbol">::ProjectList</span>)

<span class="comment">;; With route parameters:</span>
(sroute/route-to! this <span class="symbol">::ProjectDetail</span> {<span class="symbol">:project-id</span> <span class="integer">42</span>})

<span class="comment">;; From anywhere with access to the app:</span>
(sroute/route-to! app <span class="symbol">::Dashboard</span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Browser back and forward (when URL sync is installed):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(sroute/route-back! app)
(sroute/route-forward! app)</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="IstateDeepDive"><a class="anchor" href="#IstateDeepDive"></a><a class="link" href="#IstateDeepDive">7.6.5. Composed Routing with istate</a></h4>
<div class="paragraph">
<p><code>istate</code> is the mechanism for composing independently-defined statecharts into a routing hierarchy.
It creates a route state that, when entered, <strong>invokes a child statechart</strong> on the target component.</p>
</div>
<div class="paragraph">
<p>This is powerful for several reasons:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Code splitting</strong>: The child chart can be in a separate namespace, loaded lazily.</p>
</li>
<li>
<p><strong>Team boundaries</strong>: Different teams own different sub-charts without coordination.</p>
</li>
<li>
<p><strong>Isolated testing</strong>: Each child chart can be tested in isolation.</p>
</li>
<li>
<p><strong>Encapsulated lifecycle</strong>: The child chart manages its own sub-routes, data loads, and guards.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_how_istate_differs_from_rstate"><a class="anchor" href="#_how_istate_differs_from_rstate"></a><a class="link" href="#_how_istate_differs_from_rstate">How istate Differs from rstate</a></h5>
<div class="paragraph">
<p>An <code>rstate</code> is a simple route: entering it initializes a component and sets up a query join.</p>
</div>
<div class="paragraph">
<p>An <code>istate</code> does all of that AND invokes a child statechart.
The child chart runs as a separate session, with its own configuration, data model, and event processing.
When the parent exits the <code>istate</code>, the child session is terminated.</p>
</div>
</div>
<div class="sect4">
<h5 id="_co_located_charts_sfrostatechart"><a class="anchor" href="#_co_located_charts_sfrostatechart"></a><a class="link" href="#_co_located_charts_sfrostatechart">Co-located Charts (sfro/statechart)</a></h5>
<div class="paragraph">
<p>The simplest way to associate a child chart with a component is to put it directly on the component:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defsc AdminPanel [this {<span class="symbol">:ui/keys</span> [current-route]}]
  {<span class="symbol">:query</span>                   [<span class="symbol">:ui/current-route</span>]
   <span class="symbol">:ident</span>                   (<span class="keyword">fn</span> [] [<span class="symbol">:component/id</span> <span class="symbol">::AdminPanel</span>])
   <span class="symbol">:preserve-dynamic-query?</span> <span class="predefined-constant">true</span>
   sfro/statechart          admin-chart/admin-chart    <span class="comment">;; &lt;-- co-located chart</span>
   <span class="symbol">:initial-state</span>           {<span class="symbol">:ui/current-route</span> {}}})</code></pre>
</div>
</div>
<div class="paragraph">
<p>When the routing system enters this <code>istate</code>, it reads <code>sfro/statechart</code> from the component, registers it under the component&#8217;s registry key, and invokes it.</p>
</div>
</div>
<div class="sect4">
<h5 id="_pre_registered_charts_sfrostatechart_id"><a class="anchor" href="#_pre_registered_charts_sfrostatechart_id"></a><a class="link" href="#_pre_registered_charts_sfrostatechart_id">Pre-registered Charts (sfro/statechart-id)</a></h5>
<div class="paragraph">
<p>For code splitting, register the chart separately and reference it by ID:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="comment">;; At startup:</span>
(scf/register-statechart! app <span class="symbol">:my-app/admin-chart</span> admin-chart/admin-chart)

<span class="comment">;; On the component:</span>
(defsc AdminPanel [this {<span class="symbol">:ui/keys</span> [current-route]}]
  {<span class="symbol">:query</span>                   [<span class="symbol">:ui/current-route</span>]
   <span class="symbol">:ident</span>                   (<span class="keyword">fn</span> [] [<span class="symbol">:component/id</span> <span class="symbol">::AdminPanel</span>])
   <span class="symbol">:preserve-dynamic-query?</span> <span class="predefined-constant">true</span>
   sfro/statechart-id       <span class="symbol">:my-app/admin-chart</span>    <span class="comment">;; &lt;-- reference by ID</span>
   <span class="symbol">:initial-state</span>           {<span class="symbol">:ui/current-route</span> {}}})</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is the pattern used in the demo application.</p>
</div>
</div>
<div class="sect4">
<h5 id="_cross_chart_routing_via_routereachable"><a class="anchor" href="#_cross_chart_routing_via_routereachable"></a><a class="link" href="#_cross_chart_routing_via_routereachable">Cross-Chart Routing via :route/reachable</a></h5>
<div class="paragraph">
<p>The parent chart needs to know which targets exist inside the child chart so it can generate transitions to them.
This is declared with <code>:route/reachable</code> on the <code>istate</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="comment">;; In the parent chart:</span>
(sroute/istate {<span class="symbol">:route/target</span>    `ui/AdminPanel
                <span class="symbol">:route/reachable</span> #{<span class="symbol">::ui/AdminUsersList</span>
                                   <span class="symbol">::ui/AdminUserDetail</span>
                                   <span class="symbol">::ui/AdminSettings</span>}})</code></pre>
</div>
</div>
<div class="paragraph">
<p>With this declaration, <code>sroute/route-to!</code> can navigate directly to <code>::ui/AdminUsersList</code> from anywhere in the parent chart.
Two mechanisms handle this:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Not yet in the owner istate</strong>: The parent transitions into the <code>AdminPanel</code> istate and stores the desired route as <code>::pending-child-route</code>. When the child chart starts, its <code>routes</code> on-entry handler detects the pending route and raises it as an event.</p>
</li>
<li>
<p><strong>Already in the owner istate</strong>: The parent sends the route event directly to the child session via <code>scp/send!</code>. The child chart transitions internally without re-entering the <code>istate</code>.</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="_the_child_chart"><a class="anchor" href="#_the_child_chart"></a><a class="link" href="#_the_child_chart">The Child Chart</a></h5>
<div class="paragraph">
<p>A child chart used with <code>istate</code> is just a normal routing chart.
The key differences are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Its <code>:routing/root</code> is the <code>istate</code> target component (e.g. <code>AdminPanel</code>).</p>
</li>
<li>
<p>The <code>::pending-child-route</code> mechanism is handled automatically by <code>routes</code> on-entry.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">app.admin-chart</span>
  (<span class="symbol">:require</span>
    [com.fulcrologic.statecharts.chart <span class="symbol">:as</span> chart]
    [com.fulcrologic.statecharts.integration.fulcro.routing <span class="symbol">:as</span> sroute]))

(<span class="keyword">def</span> <span class="function">admin-chart</span>
  (chart/statechart {<span class="symbol">:initial</span> <span class="symbol">:admin/routes</span>}
    (sroute/routes {<span class="symbol">:id</span> <span class="symbol">:admin/routes</span> <span class="symbol">:routing/root</span> `ui/AdminPanel}
      (sroute/rstate {<span class="symbol">:route/target</span> `ui/AdminUsersList})
      (sroute/rstate {<span class="symbol">:route/target</span> `ui/AdminUserDetail <span class="symbol">:route/params</span> #{<span class="symbol">:user-id</span>}})
      (sroute/rstate {<span class="symbol">:route/target</span> `ui/AdminSettings}))))</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_advanced_istate_options"><a class="anchor" href="#_advanced_istate_options"></a><a class="link" href="#_advanced_istate_options">Advanced istate Options</a></h5>
<div class="paragraph">
<p>The <code>istate</code> function accepts additional options for controlling the child statechart invocation lifecycle. These are less commonly needed but available for advanced use cases:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>on-done</code></dt>
<dd>
<p>Transition target when the child chart reaches a final state.</p>
</dd>
<dt class="hdlist1"><code>exit-target</code></dt>
<dd>
<p>Target to transition to when the istate is exited (before the child chart is torn down).</p>
</dd>
<dt class="hdlist1"><code>invoke-params</code></dt>
<dd>
<p>Additional parameters to pass to the child chart invocation.</p>
</dd>
<dt class="hdlist1"><code>child-session-id</code></dt>
<dd>
<p>Override the auto-generated child session ID.</p>
</dd>
<dt class="hdlist1"><code>autoforward</code></dt>
<dd>
<p>When true, forwards all unhandled events to the child chart.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>See the <code>istate</code> docstring in <code>routing.cljc</code> for full details.</p>
</div>
</div>
<div class="sect4">
<h5 id="_send_to_self_for_child_chart_communication"><a class="anchor" href="#_send_to_self_for_child_chart_communication"></a><a class="link" href="#_send_to_self_for_child_chart_communication">send-to-self! for Child Chart Communication</a></h5>
<div class="paragraph">
<p>When a component has a co-located child statechart (via <code>istate</code>), it can send events to the child session:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="comment">;; From a component that is an istate target:</span>
(sroute/send-to-self! this <span class="symbol">:event/save</span> {<span class="symbol">:some</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">data</span><span class="delimiter">&quot;</span></span>})</code></pre>
</div>
</div>
<div class="paragraph">
<p>This looks up the child session ID from the Fulcro state (at <code>[:invocation/id &lt;target-key&gt;]</code> in the routing session&#8217;s local data) and forwards the event.</p>
</div>
</div>
<div class="sect4">
<h5 id="_inspecting_child_state"><a class="anchor" href="#_inspecting_child_state"></a><a class="link" href="#_inspecting_child_state">Inspecting Child State</a></h5>
<div class="paragraph">
<p>To read the current configuration of a child chart from its parent component:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(sroute/current-invocation-configuration this)
<span class="comment">;; =&gt; #{:admin/routes :region/routing-info ...}</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_sfroactors"><a class="anchor" href="#_sfroactors"></a><a class="link" href="#_sfroactors">sfro/actors</a></h5>
<div class="paragraph">
<p>When the child chart is invoked, <code>:actor/component</code> is automatically set to the target component.
If the child chart needs additional actors, declare them on the component:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defsc AdminPanel [this props]
  {sfro/actors (<span class="keyword">fn</span> [env data]
                 {<span class="symbol">:actor/sidebar</span> (scf/actor Sidebar (comp/get-ident Sidebar {}))})
   <span class="keyword">..</span><span class="keyword">.</span>})</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_authentication_guard_pattern"><a class="anchor" href="#_authentication_guard_pattern"></a><a class="link" href="#_authentication_guard_pattern">7.6.6. Authentication Guard Pattern</a></h4>
<div class="paragraph">
<p>A common requirement is redirecting unauthenticated users to a login screen, then returning them to their original destination after login.
The demo application (<code>routing-demo2/chart.cljc</code>) demonstrates this pattern.</p>
</div>
<div class="sect4">
<h5 id="_structure"><a class="anchor" href="#_structure"></a><a class="link" href="#_structure">Structure</a></h5>
<div class="paragraph">
<p>The auth guard is a <strong>plain state</strong> (not <code>rstate</code> or <code>istate</code>) that wraps the login screen and an initializing state.
It sits inside the <code>routes</code> node alongside the authenticated route states:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(sroute/routes {<span class="symbol">:id</span> <span class="symbol">:region/main</span> <span class="symbol">:routing/root</span> `ui/RoutingRoot}
  <span class="comment">;; Auth guard: intercepts route-to.* when unauthenticated</span>
  (state {<span class="symbol">:id</span> <span class="symbol">:state/unauthenticated</span> <span class="symbol">:initial</span> <span class="symbol">:state/initializing</span>}
    <span class="comment">;; Wildcard transition: catches ANY route-to.* event</span>
    (transition {<span class="symbol">:event</span> <span class="symbol">:route-to.*</span> <span class="symbol">:target</span> <span class="symbol">::ui/LoginScreen</span>}
      (script {<span class="symbol">:expr</span> save-bookmark}))
    (state {<span class="symbol">:id</span> <span class="symbol">:state/initializing</span>}
      (on-entry {} (script {<span class="symbol">:expr</span> check-session!}))
      (transition {<span class="symbol">:event</span> <span class="symbol">:auth/session-valid</span> <span class="symbol">:target</span> <span class="symbol">::ui/Dashboard</span>})
      (transition {<span class="symbol">:event</span> <span class="symbol">:auth/session-invalid</span> <span class="symbol">:target</span> <span class="symbol">::ui/LoginScreen</span>}))
    (sroute/rstate {<span class="symbol">:route/target</span> `ui/LoginScreen}
      <span class="comment">;; Login transitions...</span>
      ))

  <span class="comment">;; Authenticated routes (outside the unauthenticated state)</span>
  (sroute/rstate {<span class="symbol">:route/target</span> `ui/Dashboard}
    (on-entry {} (script {<span class="symbol">:expr</span> replay-bookmark!})))
  (sroute/rstate {<span class="symbol">:route/target</span> `ui/ProjectList <span class="symbol">:route/segment</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">projects</span><span class="delimiter">&quot;</span></span>})
  <span class="comment">;; ...more routes...</span>
  )</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_how_the_bookmark_works"><a class="anchor" href="#_how_the_bookmark_works"></a><a class="link" href="#_how_the_bookmark_works">How the Bookmark Works</a></h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The user bookmarks or deep-links to <code>/projects/ProjectDetail?_p=&#8230;&#8203;</code>.</p>
</li>
<li>
<p>On page load, the statechart starts in <code>:state/unauthenticated</code>, which checks the session.</p>
</li>
<li>
<p>If unauthenticated, the <code>route-to.*</code> wildcard transition fires first (document order), saving the original event as a bookmark.</p>
</li>
<li>
<p>The user logs in successfully, transitioning to <code>Dashboard</code>.</p>
</li>
<li>
<p><code>Dashboard&#8217;s on-entry replays the bookmark by raising the saved event via `senv/raise</code>.</p>
</li>
<li>
<p>The routing system processes the replayed event and navigates to the bookmarked destination.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The bookmark is stored as a data model assignment (<code>ops/assign</code>) and cleared after replay:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">defn-</span> <span class="function">save-bookmark</span> [_env _data event-name event-data]
  (<span class="keyword">let</span> [login-event (sroute/route-to-event-name <span class="symbol">::ui/LoginScreen</span>)]
    (<span class="keyword">if</span> (<span class="keyword">=</span> event-name login-event)
      <span class="predefined-constant">nil</span>  <span class="comment">;; don't save login route as bookmark (avoids loops)</span>
      [(ops/assign <span class="symbol">::bookmark</span> {<span class="symbol">:event-name</span> event-name <span class="symbol">:event-data</span> event-data})])))

(<span class="keyword">defn-</span> <span class="function">replay-bookmark!</span> [env data &amp; _]
  (<span class="keyword">let</span> [bookmark (<span class="keyword">get</span> data <span class="symbol">::bookmark</span>)]
    (<span class="keyword">when</span> bookmark
      (senv/raise env (<span class="symbol">:event-name</span> bookmark) (<span class="symbol">:event-data</span> bookmark)))
    <span class="comment">;; Clear bookmark after use</span>
    [(ops/assign <span class="symbol">::bookmark</span> <span class="predefined-constant">nil</span>)]))</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_pluggable_url_codec"><a class="anchor" href="#_pluggable_url_codec"></a><a class="link" href="#_pluggable_url_codec">7.6.7. Pluggable URL Codec</a></h4>
<div class="paragraph">
<p>URL encoding and decoding is handled by the <code>URLCodec</code> protocol defined in <code>routing.url-codec</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">defprotocol</span> <span class="class">URLCodec</span>
  (encode-url [this context]
    <span class="string"><span class="delimiter">&quot;</span><span class="content">Given a context map, return a URL path string (with query if needed).
     Context keys: :segments, :params, :route-elements</span><span class="delimiter">&quot;</span></span>)
  (decode-url [this href route-elements]
    <span class="string"><span class="delimiter">&quot;</span><span class="content">Given a URL string and route-elements map, return {:leaf-id :params} or nil.</span><span class="delimiter">&quot;</span></span>))</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_default_transitbase64codec"><a class="anchor" href="#_default_transitbase64codec"></a><a class="link" href="#_default_transitbase64codec">Default: TransitBase64Codec</a></h5>
<div class="paragraph">
<p>The default implementation (<code>routing.url-codec-transit</code>) encodes route parameters as transit, then base64, into a <code>_p</code> query parameter.
URL shape: <code>/Seg1/Seg2?_p=&lt;base64-encoded-transit&gt;</code>.</p>
</div>
<div class="paragraph">
<p>This is created automatically by <code>install-url-sync!</code> if you do not pass a <code>:url-codec</code> option.</p>
</div>
</div>
<div class="sect4">
<h5 id="_custom_codec"><a class="anchor" href="#_custom_codec"></a><a class="link" href="#_custom_codec">Custom Codec</a></h5>
<div class="paragraph">
<p>To implement a custom codec (e.g. human-readable query params, path-based params), implement the <code>URLCodec</code> protocol:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">require</span> '[com.fulcrologic.statecharts.integration.fulcro.routing.url-codec <span class="symbol">:as</span> ruc])

(<span class="keyword">def</span> <span class="function">my-codec</span>
  (<span class="keyword">reify</span> ruc/URLCodec
    (encode-url [_ {<span class="symbol">:keys</span> [segments route-elements params]}]
      <span class="comment">;; Build path from segments</span>
      (<span class="keyword">let</span> [seg-strs (mapv (<span class="keyword">fn</span> [state-id]
                             (ruc/element-segment (<span class="keyword">get</span> route-elements state-id)))
                       segments)
            path     (<span class="keyword">str</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">/</span><span class="delimiter">&quot;</span></span> (clojure.string/join <span class="string"><span class="delimiter">&quot;</span><span class="content">/</span><span class="delimiter">&quot;</span></span> seg-strs))]
        <span class="comment">;; Add params however you prefer</span>
        (<span class="keyword">if</span> (<span class="keyword">seq</span> params)
          (<span class="keyword">str</span> path <span class="string"><span class="delimiter">&quot;</span><span class="content">?</span><span class="delimiter">&quot;</span></span> (my-param-encoder params))
          path)))
    (decode-url [_ href route-elements]
      <span class="comment">;; Parse href, find matching leaf, extract params</span>
      <span class="keyword">..</span><span class="keyword">.</span>)))

<span class="comment">;; Pass to install-url-sync!</span>
(sroute/install-url-sync! app {<span class="symbol">:url-codec</span> my-codec})</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>ruc/element-segment</code> helper returns <code>:route/segment</code> if present, otherwise <code>(name (:route/target element))</code>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="BusyGuards"><a class="anchor" href="#BusyGuards"></a><a class="link" href="#BusyGuards">7.6.8. Busy Guards</a></h4>
<div class="paragraph">
<p>Busy guards prevent navigation away from a route when work would be lost&#8201;&#8212;&#8201;for example, an unsaved form.</p>
</div>
<div class="sect4">
<h5 id="_how_it_works"><a class="anchor" href="#_how_it_works"></a><a class="link" href="#_how_it_works">How It Works</a></h5>
<div class="paragraph">
<p>When <code>routes</code> generates transitions for each route target, it also generates a <strong>catch-all</strong> <code>route-to.<strong></code> transition with <code>sroute/busy?</code> as its guard condition.
Because statecharts evaluate transitions in document order, this catch-all fires *before</strong> the specific target transitions when the guard returns true.</p>
</div>
<div class="paragraph">
<p>The <code>sroute/busy?</code> function performs a <strong>deep recursive check</strong>:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>For each active route state, it checks if the target component has a <code>sfro/busy?</code> predicate or is a dirty Fulcro form.</p>
</li>
<li>
<p>If the route state has an invoked child chart, it recursively checks the child chart&#8217;s active states.</p>
</li>
<li>
<p>If any component at any depth returns busy, the route change is denied.</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="_adding_a_busy_predicate"><a class="anchor" href="#_adding_a_busy_predicate"></a><a class="link" href="#_adding_a_busy_predicate">Adding a Busy Predicate</a></h5>
<div class="paragraph">
<p>Add <code>sfro/busy?</code> to any route target component:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defsc BusyForm [this {<span class="symbol">:ui/keys</span> [notes]}]
  {<span class="symbol">:query</span>         [<span class="symbol">:ui/notes</span>]
   <span class="symbol">:ident</span>         (<span class="keyword">fn</span> [] [<span class="symbol">:component/id</span> <span class="symbol">::BusyForm</span>])
   <span class="symbol">:initial-state</span> {<span class="symbol">:ui/notes</span> <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>}
   sfro/busy?     (<span class="keyword">fn</span> [{<span class="symbol">:fulcro/keys</span> [app]} _data]
                    (<span class="keyword">let</span> [state-map (rapp/current-state app)
                          notes     (<span class="keyword">get-in</span> state-map [<span class="symbol">:component/id</span> <span class="symbol">::BusyForm</span> <span class="symbol">:ui/notes</span>])]
                      (<span class="keyword">and</span> (<span class="keyword">string?</span> notes) (<span class="keyword">pos?</span> (<span class="keyword">count</span> notes)))))})</code></pre>
</div>
</div>
<div class="paragraph">
<p>Fulcro forms using <code>form-state</code> are <strong>auto-guarded</strong>: a dirty form is automatically considered busy without any extra configuration.</p>
</div>
</div>
<div class="sect4">
<h5 id="_denial_lifecycle"><a class="anchor" href="#_denial_lifecycle"></a><a class="link" href="#_denial_lifecycle">Denial Lifecycle</a></h5>
<div class="paragraph">
<p>When a route transition is denied:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>record-failed-route!</code> stores the failed event in the data model.</p>
</li>
<li>
<p>The routing info region transitions to <code>:routing-info/open</code>.</p>
</li>
<li>
<p><code>sroute/route-denied?</code> returns <code>true</code>.</p>
</li>
<li>
<p>Your UI renders a confirmation dialog.</p>
</li>
<li>
<p>The user chooses one of:</p>
<div class="ulist">
<ul>
<li>
<p><code>(sroute/force-continue-routing! app)</code>&#8201;&#8212;&#8201;resends the failed event with a <code>::force?</code> flag that bypasses the busy check.</p>
</li>
<li>
<p><code>(sroute/abandon-route-change! app)</code>&#8201;&#8212;&#8201;closes the routing info and stays on the current route.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="comment">;; In your Root component's render:</span>
(<span class="keyword">when</span> (sroute/route-denied? this)
  (dom/div {}
    (dom/p {} <span class="string"><span class="delimiter">&quot;</span><span class="content">You have unsaved changes. Leave anyway?</span><span class="delimiter">&quot;</span></span>)
    (dom/button {<span class="symbol">:onClick</span> #(sroute/force-continue-routing! this)} <span class="string"><span class="delimiter">&quot;</span><span class="content">Leave</span><span class="delimiter">&quot;</span></span>)
    (dom/button {<span class="symbol">:onClick</span> #(sroute/abandon-route-change! this)} <span class="string"><span class="delimiter">&quot;</span><span class="content">Stay</span><span class="delimiter">&quot;</span></span>)))</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_url_sync_interaction_with_denial"><a class="anchor" href="#_url_sync_interaction_with_denial"></a><a class="link" href="#_url_sync_interaction_with_denial">URL Sync Interaction with Denial</a></h5>
<div class="paragraph">
<p>When URL sync is installed and the user presses the browser back button:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The popstate listener fires, sending a route event.</p>
</li>
<li>
<p>If the route is denied, <code>install-url-sync!</code> detects the mismatch between the statechart state and the browser URL.</p>
</li>
<li>
<p>It automatically restores the URL to its pre-navigation value (using <code>go-forward!</code> or <code>go-back!</code> depending on direction).</p>
</li>
<li>
<p>If an <code>:on-route-denied</code> callback was provided to <code>install-url-sync!</code>, it is called with the denied URL.</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="_disabling_guards"><a class="anchor" href="#_disabling_guards"></a><a class="link" href="#_disabling_guards">Disabling Guards</a></h5>

</div>
</div>
<div class="sect3">
<h4 id="HeadlessTesting"><a class="anchor" href="#HeadlessTesting"></a><a class="link" href="#HeadlessTesting">7.6.9. Headless Testing</a></h4>
<div class="paragraph">
<p>The <code>SimulatedURLHistory</code> provider enables full routing testing without a browser.
It is cross-platform (CLJ + CLJS) and works in kaocha, REPL, and CI environments.</p>
</div>
<div class="sect4">
<h5 id="_test_setup"><a class="anchor" href="#_test_setup"></a><a class="link" href="#_test_setup">Test Setup</a></h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">require</span> '[com.fulcrologic.fulcro.application <span class="symbol">:as</span> app]
         '[com.fulcrologic.fulcro.components <span class="symbol">:as</span> <span class="keyword">comp</span> <span class="symbol">:refer</span> [defsc]]
         '[com.fulcrologic.statecharts.integration.fulcro <span class="symbol">:as</span> scf]
         '[com.fulcrologic.statecharts.integration.fulcro.routing <span class="symbol">:as</span> sroute]
         '[com.fulcrologic.statecharts.integration.fulcro.routing.simulated-history <span class="symbol">:as</span> rsh]
         '[com.fulcrologic.statecharts.integration.fulcro.routing.url-history <span class="symbol">:as</span> ruh])

<span class="comment">;; Minimal route components</span>
(defsc RootComp [_ _]
  {<span class="symbol">:query</span> [<span class="symbol">:ui/current-route</span>]
   <span class="symbol">:ident</span> (<span class="keyword">fn</span> [] [<span class="symbol">:component/id</span> <span class="symbol">::root</span>])
   <span class="symbol">:initial-state</span> {<span class="symbol">:ui/current-route</span> {}}})

(defsc PageA [_ _]
  {<span class="symbol">:query</span> [<span class="symbol">:page/id</span>]
   <span class="symbol">:ident</span> <span class="symbol">:page/id</span>
   <span class="symbol">:initial-state</span> {<span class="symbol">:page/id</span> <span class="symbol">:a</span>}})

(defsc PageB [_ _]
  {<span class="symbol">:query</span> [<span class="symbol">:page/id</span>]
   <span class="symbol">:ident</span> <span class="symbol">:page/id</span>
   <span class="symbol">:initial-state</span> {<span class="symbol">:page/id</span> <span class="symbol">:b</span>}})

<span class="comment">;; Create headless app with synchronous processing</span>
(<span class="keyword">defn</span> <span class="function">test-app</span> []
  (<span class="keyword">let</span> [a (app/fulcro-app)]
    (app/set-root! a RootComp {<span class="symbol">:initialize-state?</span> <span class="predefined-constant">true</span>})
    (scf/install-fulcro-statecharts! a {<span class="symbol">:event-loop?</span> <span class="predefined-constant">false</span>})
    a))</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_testing_programmatic_navigation"><a class="anchor" href="#_testing_programmatic_navigation"></a><a class="link" href="#_testing_programmatic_navigation">Testing Programmatic Navigation</a></h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">let</span> [app      (test-app)
      provider (rsh/simulated-url-history <span class="string"><span class="delimiter">&quot;</span><span class="content">/</span><span class="delimiter">&quot;</span></span>)]
  (sroute/start! app my-routing-chart)
  (scf/process-events! app)
  (<span class="keyword">let</span> [cleanup (sroute/install-url-sync! app {<span class="symbol">:provider</span> provider})]
    (sroute/url-sync-on-save sroute/session-id <span class="predefined-constant">nil</span> app)

    <span class="comment">;; Navigate</span>
    (sroute/route-to! app `PageB)
    (scf/process-events! app)
    (sroute/url-sync-on-save sroute/session-id <span class="predefined-constant">nil</span> app)

    <span class="comment">;; Assert URL and route state</span>
    (<span class="keyword">assert</span> (<span class="keyword">=</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">/PageB</span><span class="delimiter">&quot;</span></span> (ruh/current-href provider)))
    (<span class="keyword">assert</span> (<span class="keyword">=</span> <span class="integer">2</span> (<span class="keyword">count</span> (rsh/history-stack provider))))

    (cleanup)))</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_testing_browser_backforward_clj_only"><a class="anchor" href="#_testing_browser_backforward_clj_only"></a><a class="link" href="#_testing_browser_backforward_clj_only">Testing Browser Back/Forward (CLJ Only)</a></h5>
<div class="paragraph">
<p>Browser back/forward requires synchronous event processing, so these tests must be CLJ-only:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="comment">;; After programmatic navigation A -&gt; B -&gt; C:</span>
(ruh/go-back! provider)
(scf/process-events! app)
(sroute/url-sync-on-save sroute/session-id <span class="predefined-constant">nil</span> app)
<span class="comment">;; Now on page B; history stack unchanged</span>

(ruh/go-forward! provider)
(scf/process-events! app)
(sroute/url-sync-on-save sroute/session-id <span class="predefined-constant">nil</span> app)
<span class="comment">;; Back on page C</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_testing_route_denial"><a class="anchor" href="#_testing_route_denial"></a><a class="link" href="#_testing_route_denial">Testing Route Denial</a></h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="comment">;; Navigate to a busy page, then try to go back</span>
(ruh/go-back! provider)
(scf/process-events! app)
(sroute/url-sync-on-save sroute/session-id <span class="predefined-constant">nil</span> app)

(<span class="keyword">assert</span> (<span class="keyword">true?</span> (sroute/route-denied? app)))
<span class="comment">;; URL is restored to the busy page's URL</span>

<span class="comment">;; Force continue</span>
(sroute/force-continue-routing! app)
(scf/process-events! app)
(scf/process-events! app)  <span class="comment">;; extra round for re-queued event</span>
(sroute/url-sync-on-save sroute/session-id <span class="predefined-constant">nil</span> app)

(<span class="keyword">assert</span> (<span class="keyword">false?</span> (sroute/route-denied? app)))</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_simulatedurlhistory_inspection_helpers"><a class="anchor" href="#_simulatedurlhistory_inspection_helpers"></a><a class="link" href="#_simulatedurlhistory_inspection_helpers">SimulatedURLHistory Inspection Helpers</a></h5>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>(rsh/history-stack provider)</code></dt>
<dd>
<p>Returns a vector of URL strings.</p>
</dd>
<dt class="hdlist1"><code>(rsh/history-cursor provider)</code></dt>
<dd>
<p>Returns the current cursor position (zero-based index).</p>
</dd>
<dt class="hdlist1"><code>(rsh/history-entries provider)</code></dt>
<dd>
<p>Returns the full entries vector with <code>:url</code> and <code>:index</code> keys.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>See <code>url_sync_headless_spec.cljc</code> in the test suite for comprehensive examples covering cross-chart routing, custom segments, and denial recovery.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_api_reference"><a class="anchor" href="#_api_reference"></a><a class="link" href="#_api_reference">7.6.10. API Reference</a></h4>
<div class="sect4">
<h5 id="_chart_construction"><a class="anchor" href="#_chart_construction"></a><a class="link" href="#_chart_construction">Chart Construction</a></h5>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 42.8571%;">
<col style="width: 57.1429%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Function</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sroute/routing-regions</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Wraps routes in parallel state with denial modal support.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sroute/routes</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Container for route states. Generates transitions for all targets.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sroute/rstate</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Route state. On-entry: params, init, query rewrite.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sroute/istate</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Route state that invokes a child statechart.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="_lifecycle"><a class="anchor" href="#_lifecycle"></a><a class="link" href="#_lifecycle">Lifecycle</a></h5>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 42.8571%;">
<col style="width: 57.1429%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Function</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sroute/start! [app chart]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Registers chart and starts routing session.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sroute/start! [app chart opts]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Same, with <code>:routing/checks</code> option.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sroute/install-url-sync! [app]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Installs URL sync with defaults. Returns cleanup fn.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sroute/install-url-sync! [app opts]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">With <code>:provider</code>, <code>:url-codec</code>, <code>:prefix</code>, <code>:on-route-denied</code>, <code>:routing/checks</code>.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="_navigation_2"><a class="anchor" href="#_navigation_2"></a><a class="link" href="#_navigation_2">Navigation</a></h5>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 42.8571%;">
<col style="width: 57.1429%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Function</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sroute/route-to! [app-ish target]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Navigate to target (class or keyword).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sroute/route-to! [app-ish target data]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Navigate with route params.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sroute/route-back! [app-ish]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Browser back via URL sync provider.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sroute/route-forward! [app-ish]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Browser forward via URL sync provider.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sroute/send-to-self! [this event data]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Send event to co-located child chart.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="_guard_and_denial"><a class="anchor" href="#_guard_and_denial"></a><a class="link" href="#_guard_and_denial">Guard and Denial</a></h5>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 42.8571%;">
<col style="width: 57.1429%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Function</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sroute/busy? [env data]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Deep recursive busy check (guard condition).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sroute/route-denied? [app-ish]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">True if routing info is in open/denied state.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sroute/force-continue-routing! [app-ish]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Override guard and retry denied route.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sroute/abandon-route-change! [app-ish]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cancel denied route, close routing info.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="_state_inspection"><a class="anchor" href="#_state_inspection"></a><a class="link" href="#_state_inspection">State Inspection</a></h5>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 42.8571%;">
<col style="width: 57.1429%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Function</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sroute/active-leaf-routes [app-ish]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set of active leaf route state IDs (cross-chart).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sroute/reachable-targets [chart]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set of all reachable target keywords in a chart.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sroute/current-invocation-configuration [this]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Child chart&#8217;s configuration from parent component.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sroute/has-routes? [chart id]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">True if state contains routes (single chart).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sroute/leaf-route? [chart id]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">True if state is a leaf route (single chart).</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="_rendering"><a class="anchor" href="#_rendering"></a><a class="link" href="#_rendering">Rendering</a></h5>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 42.8571%;">
<col style="width: 57.1429%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Function</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sroute/ui-current-subroute [this factory-fn]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Render active child in standard routing region.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sroute/ui-parallel-route [this key factory-fn]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Render one child in a parallel routing region.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="_url_sync_helpers"><a class="anchor" href="#_url_sync_helpers"></a><a class="link" href="#_url_sync_helpers">URL Sync Helpers</a></h5>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 42.8571%;">
<col style="width: 57.1429%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Function</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sroute/url-sync-on-save [sid wmem app]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Call from <code>:on-save</code> to drive URL sync.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sroute/url-sync-provider [app-ish]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Returns installed URLHistoryProvider.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sroute/url-sync-installed? [app-ish]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">True if URL sync is active.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sroute/route-current-url [app-ish]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Current URL from provider.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sroute/route-history-index [app-ish]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Current history index from provider.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sroute/route-sync-from-url! [app-ish]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Re-parse current URL and route to match.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="_constants"><a class="anchor" href="#_constants"></a><a class="link" href="#_constants">Constants</a></h5>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 42.8571%;">
<col style="width: 57.1429%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Var</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sroute/session-id</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The well-known session ID (<code>::session</code>) for routing.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="_utilities"><a class="anchor" href="#_utilities"></a><a class="link" href="#_utilities">Utilities</a></h5>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 42.8571%;">
<col style="width: 57.1429%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Function</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sroute/route-to-event-name [target]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Converts a target (class or keyword) to the <code>:route-to.&lt;fqn&gt;</code> event keyword. Useful in auth guard patterns.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Functions like <code>route-to!</code>, <code>route-back!</code>, and others accept either a Fulcro app instance or a component instance (referred to as <code>app-ish</code> in the source). Use whichever is convenient in your context.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="ComponentOptions"><a class="anchor" href="#ComponentOptions"></a><a class="link" href="#ComponentOptions">7.6.11. Component Options Reference</a></h4>
<div class="paragraph">
<p>Route target components can declare these options via <code>rc/component-options</code> (namespace alias <code>sfro</code> for <code>routing-options</code>):</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>sfro/initialize</code></dt>
<dd>
<p>One of <code>:once</code> (default), <code>:always</code>, or <code>:never</code>. Controls when the routing on-entry handler initializes the target component&#8217;s state. Forms default to <code>:always</code>; reports and plain components default to <code>:once</code>.</p>
</dd>
<dt class="hdlist1"><code>sfro/initial-props</code></dt>
<dd>
<p>A <code>(fn [env data] props-map)</code> that returns initial state for the route target. Defaults to <code>rc/get-initial-state</code>. Required when the target has a dynamic ident that depends on event data.</p>
</dd>
<dt class="hdlist1"><code>sfro/busy?</code></dt>
<dd>
<p>A <code>(fn [env data] boolean?)</code> predicate. When true, routing away from this target is denied. Forms with <code>form-state</code> are auto-guarded (dirty form = busy).</p>
</dd>
<dt class="hdlist1"><code>sfro/statechart</code></dt>
<dd>
<p>A co-located statechart definition. Auto-registered using the component&#8217;s registry key when the <code>istate</code> is entered.</p>
</dd>
<dt class="hdlist1"><code>sfro/statechart-id</code></dt>
<dd>
<p>The ID of a pre-registered statechart to invoke when the component is routed to (alternative to <code>sfro/statechart</code>).</p>
</dd>
<dt class="hdlist1"><code>sfro/actors</code></dt>
<dd>
<p>A <code>(fn [env data] actors-map)</code> returning additional actors for the co-located statechart. The <code>:actor/component</code> actor is always set automatically.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_route_configuration_validation"><a class="anchor" href="#_route_configuration_validation"></a><a class="link" href="#_route_configuration_validation">7.6.12. Route Configuration Validation</a></h4>
<div class="paragraph">
<p><code>start!</code> and <code>install-url-sync!</code> accept a <code>:routing/checks</code> option that controls how route configuration problems are reported:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="comment">;; Default: warnings are logged but execution continues</span>
(sroute/start! app routing-chart)

<span class="comment">;; Strict mode: throws ex-info on any configuration problem</span>
(sroute/start! app routing-chart {<span class="symbol">:routing/checks</span> <span class="symbol">:strict</span>})</code></pre>
</div>
</div>
<div class="paragraph">
<p>The validator detects:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Duplicate leaf names</strong>&#8201;&#8212;&#8201;two route targets whose URL segment (<code>:route/segment</code> or <code>(name target)</code>) collides, causing ambiguous URL matching.</p>
</li>
<li>
<p><strong>Duplicate segment chains</strong>&#8201;&#8212;&#8201;two leaf routes with identical full segment paths (e.g. both resolve to <code>/users/edit</code>).</p>
</li>
<li>
<p><strong>Reachable collisions</strong>&#8201;&#8212;&#8201;a <code>:route/reachable</code> target whose simple name collides with a direct route target.</p>
</li>
<li>
<p><strong>Invalid routing root</strong>&#8201;&#8212;&#8201;a <code>routes</code> node with a nil or non-coercible <code>:routing/root</code>.</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
Use <code>:routing/checks :strict</code> during development to catch configuration problems as thrown exceptions rather than logged warnings.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_routing_invariants"><a class="anchor" href="#_routing_invariants"></a><a class="link" href="#_routing_invariants">7.6.13. Routing Invariants</a></h4>
<div class="paragraph">
<p>The following invariants hold for statechart-driven routing:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Constant ident roots</dt>
<dd>
<p>The <code>:routing/root</code> component MUST have a constant ident (e.g. <code>[:component/id ::Root]</code>). A nil second element in the ident is an error and the routing entry handler will log an error and skip query rewriting. The app root (no ident) is also acceptable.</p>
</dd>
<dt class="hdlist1">Dynamic query preservation</dt>
<dd>
<p>Route target parents MUST set <code>:preserve-dynamic-query? true</code> in their component options. Without this, Fulcro hot code reload will reset the dynamically-rewritten query, breaking the active route&#8217;s rendering.</p>
</dd>
<dt class="hdlist1">Unique URL segments</dt>
<dd>
<p>Each route target&#8217;s URL segment (<code>:route/segment</code> or the simple name of <code>:route/target</code>) must be unique within its routing region. Duplicate segments cause ambiguous URL-to-route matching. Use <code>:routing/checks :strict</code> during development to catch these early.</p>
</dd>
<dt class="hdlist1">Guard evaluation order</dt>
<dd>
<p>When a route transition is attempted, <code>sroute/busy?</code> is evaluated first. If any active route target (at any depth in the invocation tree) returns busy, the transition is denied and <code>record-failed-route!</code> stores the event for potential retry via <code>force-continue-routing!</code>.</p>
</dd>
<dt class="hdlist1">Single routing session</dt>
<dd>
<p>All routing goes through the single <code>sroute/session-id</code> session. Parallel regions within the routing chart handle multiple independent routing areas&#8201;&#8212;&#8201;do not create multiple routing sessions.</p>
</dd>
<dt class="hdlist1">State ID derivation</dt>
<dd>
<p>Both <code>rstate</code> and <code>istate</code> derive their <code>:id</code> from <code>:route/target</code>. Passing an explicit <code>:id</code> throws an exception. This ensures state IDs and route targets are always consistent.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_common_gotchas_and_troubleshooting"><a class="anchor" href="#_common_gotchas_and_troubleshooting"></a><a class="link" href="#_common_gotchas_and_troubleshooting">7.6.14. Common Gotchas and Troubleshooting</a></h4>
<div class="sect4">
<h5 id="_route_renders_blank_no_props"><a class="anchor" href="#_route_renders_blank_no_props"></a><a class="link" href="#_route_renders_blank_no_props">Route renders blank / no props</a></h5>
<div class="paragraph">
<p>The most common cause is a missing <code>:preserve-dynamic-query? true</code> on the parent component that renders <code>ui-current-subroute</code>.
Without it, Fulcro hot reload resets the query, losing the join to the active route target.</p>
</div>
<div class="paragraph">
<p>Also verify that the <code>:routing/root</code> component has a constant ident.
A nil ident second element causes the routing entry handler to skip query rewriting entirely.</p>
</div>
</div>
<div class="sect4">
<h5 id="_route_transition_does_nothing"><a class="anchor" href="#_route_transition_does_nothing"></a><a class="link" href="#_route_transition_does_nothing">Route transition does nothing</a></h5>
<div class="paragraph">
<p>Check whether the route is being denied by a busy guard.
Call <code>(sroute/route-denied? app)</code> to verify.
If the route is denied, either clear the busy condition or use <code>force-continue-routing!</code>.</p>
</div>
<div class="paragraph">
<p>Also ensure the target is reachable: for targets inside a child chart, the parent&#8217;s <code>istate</code> must declare the target in <code>:route/reachable</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_url_does_not_update_after_navigation"><a class="anchor" href="#_url_does_not_update_after_navigation"></a><a class="link" href="#_url_does_not_update_after_navigation">URL does not update after navigation</a></h5>
<div class="paragraph">
<p>Verify that:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>sroute/url-sync-on-save</code> is being called from the <code>:on-save</code> handler of <code>install-fulcro-statecharts!</code>.</p>
</li>
<li>
<p><code>install-url-sync!</code> was called <strong>after</strong> <code>start!</code>.</p>
</li>
<li>
<p>The app instance passed to <code>url-sync-on-save</code> is the same one passed to <code>install-url-sync!</code>.</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="_bookmarked_url_does_not_restore_after_login"><a class="anchor" href="#_bookmarked_url_does_not_restore_after_login"></a><a class="link" href="#_bookmarked_url_does_not_restore_after_login">Bookmarked URL does not restore after login</a></h5>
<div class="paragraph">
<p>The auth guard pattern (see above) requires that:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The <code>route-to.<strong></code> wildcard transition is *before</strong> the specific login route transition in document order.</p>
</li>
<li>
<p>The save-bookmark function skips saving when the event targets the login screen itself (to avoid infinite loops).</p>
</li>
<li>
<p>The replay-bookmark function uses <code>senv/raise</code> to re-inject the saved event.</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="_child_chart_routes_show_wrong_url"><a class="anchor" href="#_child_chart_routes_show_wrong_url"></a><a class="link" href="#_child_chart_routes_show_wrong_url">Child chart routes show wrong URL</a></h5>
<div class="paragraph">
<p>When URL sync is installed, pass <code>app</code> (not just <code>session-id</code>) to <code>url-sync-on-save</code>.
This enables the parent chain lookup that delegates child session saves to the root session&#8217;s URL handler.
Without it, child chart transitions do not update the URL.</p>
</div>
</div>
<div class="sect4">
<h5 id="_hot_reload_breaks_routing"><a class="anchor" href="#_hot_reload_breaks_routing"></a><a class="link" href="#_hot_reload_breaks_routing">Hot reload breaks routing</a></h5>
<div class="paragraph">
<p>Use the <code>defonce</code> + cleanup atom pattern shown in the setup section.
Without cleanup, each hot reload adds another popstate listener, causing duplicate event processing.</p>
</div>
</div>
<div class="sect4">
<h5 id="_install_url_sync_throws_no_routing_session_found"><a class="anchor" href="#_install_url_sync_throws_no_routing_session_found"></a><a class="link" href="#_install_url_sync_throws_no_routing_session_found">install-url-sync! throws "no routing session found"</a></h5>
<div class="paragraph">
<p><code>install-url-sync!</code> must be called after <code>start!</code>.
It reads the routing session&#8217;s working memory to find the statechart registration key.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_testing"><a class="anchor" href="#_testing"></a><a class="link" href="#_testing">8. Testing</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The main interface to this library is pure and functional, which makes the general job of testing easier in some cases, but the fact is that you often need to walk a state chart through several steps in order to get it <strong>into</strong> the starting configuration to test.</p>
</div>
<div class="paragraph">
<p>The fact that nodes can execute (possibly side-effecting) code also means that when testing it is usually desirable to eliminate these side effects through some kind of stubbing mechanism.</p>
</div>
<div class="paragraph">
<p>Fortunately the design of the library makes it trivial to plug in a mock execution model, mock event queue, and a test data model, which allows you to easily exercise a state chart in tests in ways that do not side effect in an uncontrolled fashion.</p>
</div>
<div class="paragraph">
<p>The <code>com.fulcrologic.statecharts.testing</code> namespace includes mocks for the necessary protocols, allows for a pluggable data model (defaults to flat working memory), and has pre-written helpers and predicates.</p>
</div>
<div class="paragraph">
<p>The mock execution model allows you to easily set up specific results for expressions and conditions that would normally be run.</p>
</div>
<div class="paragraph">
<p>Here is an example test (written with fulcro-spec):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">com.fulcrologic.statecharts.testing-spec</span>
  (<span class="symbol">:require</span>
    [com.fulcrologic.statecharts.chart <span class="symbol">:as</span> chart]
    [com.fulcrologic.statecharts.elements <span class="symbol">:refer</span> [state transition]]
    [com.fulcrologic.statecharts.testing <span class="symbol">:as</span> testing]
    [fulcro-spec.core <span class="symbol">:refer</span> [=&gt; assertions component specification]]))

(<span class="keyword">defn</span> <span class="function">is-tuesday?</span> [env data] <span class="predefined-constant">false</span>)

(<span class="keyword">def</span> <span class="function">some-statechart</span>
  (chart/statechart {}
    (state {<span class="symbol">:id</span> <span class="symbol">:state/start</span>}
      (transition {<span class="symbol">:cond</span>   is-tuesday?
                   <span class="symbol">:event</span>  <span class="symbol">:event/trigger</span>
                   <span class="symbol">:target</span> <span class="symbol">:state/next</span>}))
    (state {<span class="symbol">:id</span> <span class="symbol">:state/next</span>})))

(<span class="keyword">defn</span> <span class="function">config</span> [] {<span class="symbol">:statechart</span> some-statechart})

(specification <span class="string"><span class="delimiter">&quot;</span><span class="content">My Machine</span><span class="delimiter">&quot;</span></span>
  (component <span class="string"><span class="delimiter">&quot;</span><span class="content">When it is tuesday</span><span class="delimiter">&quot;</span></span>
    (<span class="keyword">let</span> [env (testing/new-testing-env (config) {is-tuesday? <span class="predefined-constant">true</span>})]

      (testing/start! env)
      (testing/run-events! env <span class="symbol">:event/trigger</span>)

      (assertions
        <span class="string"><span class="delimiter">&quot;</span><span class="content">Checks to see that it is tuesday</span><span class="delimiter">&quot;</span></span>
        (testing/ran? env is-tuesday?) =&gt; <span class="predefined-constant">true</span>
        <span class="string"><span class="delimiter">&quot;</span><span class="content">Goes to the next state</span><span class="delimiter">&quot;</span></span>
        (testing/in? env <span class="symbol">:state/next</span>) =&gt; <span class="predefined-constant">true</span>)

      (testing/goto-configuration! env [] #{<span class="symbol">:state/start</span>})

      (assertions
        <span class="string"><span class="delimiter">&quot;</span><span class="content">Can be forced into a state</span><span class="delimiter">&quot;</span></span>
        (testing/in? env <span class="symbol">:state/start</span>) =&gt; <span class="predefined-constant">true</span>))))</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_mocking"><a class="anchor" href="#_mocking"></a><a class="link" href="#_mocking">8.1. Mocking</a></h3>
<div class="paragraph">
<p>The mocking (set when creating the testing env) is a simple map (e.g. <code>{is-tuesday? true}</code>).
The keys of the map must exactly match the expression in question (e.g. use <code>defn</code> to make them (as shown above), and then use those as the cond/expr so you can match on it).
The values in the mocking map can be literal values OR functions.
If they are functions then they will be passed the <code>env</code>, which will include the special key <code>:ncalls</code> that will have the count (inclusive) of the number of times that expression has run since the test env was created.</p>
</div>
</div>
<div class="sect2">
<h3 id="_event_sendscancels"><a class="anchor" href="#_event_sendscancels"></a><a class="link" href="#_event_sendscancels">8.2. Event Sends/Cancels</a></h3>
<div class="paragraph">
<p>The sends and cancels will also be auto-recorded.
See the docstrings in the testing namespace for more information.</p>
</div>
</div>
<div class="sect2">
<h3 id="_starting_in_a_specific_configuration"><a class="anchor" href="#_starting_in_a_specific_configuration"></a><a class="link" href="#_starting_in_a_specific_configuration">8.3. Starting in a Specific Configuration</a></h3>
<div class="paragraph">
<p>Most of your tests will need the chart to be in some particular state as part of your setup.
You <strong>could</strong> get there by triggering a sequence of events while having the mocks in perfect condition, but this creates a fragile test where changes to the structure of the chart break a bunch of tests.
The testing helpers include
<code>(testing/goto-configuration! env data-ops config)</code> that allows you to set up the data model and configuration.</p>
</div>
<div class="paragraph">
<p>The <code>data-ops</code> is a vector of Data Model operations (e.g. ops/assign) to run on the data model. and <code>config</code> is a valid configuration (set of active states) for the chart.
Unfortunately, the configuration of a state chart is non-trivial (it must include all active states in a complex hierarchy) and will change when you refactor the chart.
So, another helper <code>testing/configuration-for-states</code> allows you to get a list of <strong>all</strong> of the states that would be active <strong>given</strong> the deepest desired leaf state(s).</p>
</div>
<div class="paragraph">
<p>In a chart with no parallel states, there will only ever be one leaf, but when parallel states are active you must list a valid leaf from each region.</p>
</div>
<div class="paragraph">
<p>Thus, a common test setup will look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">defn</span> <span class="function">config</span> [] {<span class="symbol">:statechart</span> some-statechart})

(specification <span class="string"><span class="delimiter">&quot;</span><span class="content">Starting in Some State</span><span class="delimiter">&quot;</span></span>
  (<span class="keyword">let</span> [env (testing/new-testing-env (config) {})]

    <span class="comment">;; assume a top-level parallel node, with two sub-regions. An internal call to `configuration-for-states`</span>
    <span class="comment">;; will populate all of the necessary ancestor states from these leaves.</span>
    (testing/goto-configuration! env [] #{<span class="symbol">:state.region1/leaf</span> <span class="symbol">:state.region2/leaf</span>})
    (testing/run-events! env <span class="symbol">:event/expired</span>)

    <span class="comment">;; assertions</span>
    ))</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_relationship_to_scxml"><a class="anchor" href="#_relationship_to_scxml"></a><a class="link" href="#_relationship_to_scxml">9. Relationship to SCXML</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>This library&#8217;s internal implementation follows (as closely as possible) the official
<a href="https://www.w3.org/TR/2015/REC-scxml-20150901/#AlgorithmforSCXMLInterpretation">State Chart XML Algorithm</a>.
In fact, much of the implementation uses internal volatiles in order to match the imperative style of that doc for easier comparison and avoidance of bugs.</p>
</div>
<div class="paragraph">
<p>The actual structure of the live CLJC data used to represent charts also closely mimics the structure described there, but with some differences for convenient use in CLJC.</p>
</div>
<div class="paragraph">
<p>Specifically, executable content is <strong>still</strong> treated as <strong>data</strong>.
The flow control XML nodes from the standard (<code>if</code>, <code>elseif</code>, <code>else</code>, <code>foreach</code>) have native Clojure function equivalents (see <a href="#_flow_control_elements">Flow Control Elements</a>).
Some other XML nodes are abbreviated or handled differently, since a conformant XML reader (which would need to be aware of the target execution model) can easily translate such nodes into the target data representation (even if that target representation is script strings).</p>
</div>
<div class="paragraph">
<p>Some of the data model elements are also abbreviated in a similar manner.
See the docstrings for details.</p>
</div>
<div class="paragraph">
<p>Thus, if you are trying to read SCXML documents you will need to write (or find) an XML reader that can do this interpretation.</p>
</div>
<div class="paragraph">
<p>For example, an XML reader that targets <a href="https://github.com/babashka/sci">sci</a> (the Clojure interpreter) might convert the XML (where <code>a</code> and <code>do-something</code> are implied values in the data and excution model):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;if</span> <span class="attribute-name">cond</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">(= 1 a)</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  (let [b (inc a)]
    (do-something b))
<span class="tag">&lt;/if&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>into (scope and args still determined by the execution model selected):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="comment">;; String-based interpretation</span>
(script {<span class="symbol">:expr</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">(if (= 1 a)
     (let [b (inc a)]
       (do-something b)))</span><span class="delimiter">&quot;</span></span>})

<span class="comment">;; OR eval-based</span>
(script {<span class="symbol">:expr</span>
  '(<span class="keyword">if</span> (<span class="keyword">=</span> <span class="integer">1</span> a)
     (<span class="keyword">let</span> [b (<span class="keyword">inc</span> a)]
       (do-something b)))})

<span class="comment">;; OR functional</span>
(script {<span class="symbol">:expr</span> (<span class="keyword">fn</span> [env {<span class="symbol">:keys</span> [a]}]
                  (<span class="keyword">if</span> (<span class="keyword">=</span> <span class="integer">1</span> a)
                    (<span class="keyword">let</span> [b (<span class="keyword">inc</span> a)]
                      (do-something b))))})</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you&#8217;re using XML tools to generate your charts, though, it&#8217;s probably easiest to use
<code>script</code> tags to begin with.</p>
</div>
<div class="sect2">
<h3 id="_related_work"><a class="anchor" href="#_related_work"></a><a class="link" href="#_related_work">9.1. Related Work</a></h3>
<div class="paragraph">
<p>The primary alternative to this library is <a href="https://github.com/lucywang000/clj-statecharts">clj-statecharts</a>, which is a fine library modelled after xstate.</p>
</div>
<div class="paragraph">
<p>This library exists for the following reasons:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>At the time this library was created, <a href="https://github.com/lucywang000/clj-statecharts/">clj-statecharts</a> was missing features.
In particular history nodes, which we needed.
I looked at clj-statecharts in order to try to add history, but some of the internal decisions made it more difficult to add (with correct semantics) and the Eclipse license made it less appealing for internal customization as a base in commercial software (see <a href="https://www.juxt.pro/blog/prefer-mit" class="bare">https://www.juxt.pro/blog/prefer-mit</a>).</p>
</li>
<li>
<p>To create an SCXML-like implementation that uses the algorithm defined in the W3C Recommended document, and can (grow to) run (with minor transformations) SCXML docs that are targeted to Clojure with the semantics defined there (such as they are).</p>
</li>
<li>
<p>To define more refined abstract mechanisms such that the state charts can be associated to long-lived things (such as a monetary transaction that happens over time) and be customized to interface with things like durable queues for events (e.g. AWS SQS) and reliable timers.</p>
</li>
<li>
<p>MIT licensing instead of Eclipse.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Other related libraries and implementations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://xstate.js.org/">XState</a> : Javascript.
Could be used from CLJS.</p>
</li>
<li>
<p><a href="https://commons.apache.org/proper/commons-scxml/">Apache SCXML</a> : Stateful and imperative.
Requires writing classes.
Requires you use XML.</p>
</li>
<li>
<p><a href="https://github.com/fulcrologic/fulcro/blob/develop/src/main/com/fulcrologic/fulcro/ui_state_machines.cljc">Fulcro UI State Machines</a>
: A finite state machine namespace (part of Fulcro) that is tightly coupled to Fulcro&#8217;s needs (full stack operation in the context of Fulcro UI and I/O).</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_conformance"><a class="anchor" href="#_conformance"></a><a class="link" href="#_conformance">9.2. Conformance</a></h3>
<div class="paragraph">
<p>This library was written using the reference implementation described in the <a href="https://www.w3.org/TR/scxml">SCXML standard</a>, but without the requirement that the chart be written in XML.</p>
</div>
<div class="paragraph">
<p>Any deviation from the standard (as far as general operation of state transitions, order of execution of entry/exit, etc.) should be considered a bug.
Note that it is possible for a bugfix in this library to change the behavior of your code (if you wrote it in a way that depends on the misbehavior); therefore, even though this library does not intend to make breaking changes, it is possible that a bugfix could affect your code&#8217;s operation.</p>
</div>
<div class="paragraph">
<p>If future versions of the standard are released that cause incompatible changes, then this library will add a new namespace for that new standard (not break versioning).</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2026-02-19 19:56:38 -0500
</div>
</div>
</body>
</html>